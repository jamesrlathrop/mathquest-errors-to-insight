<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="dark" />
  <title>BeTheMath: Error Detective ‚Äî Errors to Insight</title>

  <style>
    :root{
      --bg:#0b1020;
      --panel:#121a31;
      --card:rgba(18,26,49,.55);
      --line:rgba(230,233,242,.14);
      --text:rgba(230,233,242,.98);
      --muted:rgba(230,233,242,.78);
      --muted2:rgba(230,233,242,.62);
      --good:#37d67a;
      --bad:#ff5c7a;
      --warn:#ffd166;
      --accent:#8ab4ff;
      --accent2:#b28dff;
      --shadow: 0 10px 26px rgba(0,0,0,.32);
      --r:16px;
      --gap:14px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --font-alt: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --scale: 100%;
    }

    /* High-contrast variant */
    body.hc{
      --bg:#050814;
      --panel:#0b1230;
      --card:rgba(10,18,48,.7);
      --line:rgba(255,255,255,.24);
      --text:rgba(255,255,255,.98);
      --muted:rgba(255,255,255,.86);
      --muted2:rgba(255,255,255,.72);
      --accent:#9ad0ff;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:var(--font);
      font-size: var(--scale);
    }

    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}

    .wrap{
      max-width:1180px;
      margin: 18px auto 48px;
      padding: 0 14px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 14px;
    }
    .brand{
      display:flex;
      flex-direction:column;
      line-height:1.15;
    }
    .brand .name{
      font-weight:850;
      font-size:1.1rem;
      letter-spacing:.2px;
    }
    .brand .tag{
      color:var(--muted2);
      font-size:.92rem;
    }
    .nav{
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
      opacity:.95;
    }
    .pill{
      border:1px solid rgba(230,233,242,.18);
      border-radius:999px;
      padding:6px 10px;
      font-size:.92rem;
      background: rgba(18,26,49,.35);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.08fr .92fr;
      gap: var(--gap);
      align-items:start;
    }

    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr}
    }

    .card{
      border:1px solid var(--line);
      border-radius: var(--r);
      background: var(--card);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .card h2,.card h3{
      margin: 0 0 8px;
      letter-spacing:.2px;
    }
    .subtitle{
      color:var(--muted);
      margin: 0 0 12px;
      line-height:1.35;
    }

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .row > *{flex: 1 1 auto}
    .row.tight{gap:8px}

    label{
      display:block;
      font-size:.88rem;
      color:var(--muted);
      margin: 0 0 6px;
    }

    select,input[type="text"],input[type="range"],button{
      width:100%;
      border-radius: 12px;
      border:1px solid rgba(230,233,242,.18);
      background: rgba(12,18,40,.55);
      color:var(--text);
      padding: 10px 10px;
      outline:none;
    }
    input[type="range"]{padding: 10px 6px;}
    button{
      cursor:pointer;
      font-weight:700;
      transition: transform .05s ease, filter .1s ease;
    }
    button:active{transform: translateY(1px)}
    button.primary{
      border-color: rgba(138,180,255,.35);
      background: linear-gradient(135deg, rgba(138,180,255,.18), rgba(178,141,255,.16));
    }
    button.ghost{
      background: rgba(18,26,49,.25);
    }
    button.danger{
      border-color: rgba(255,92,122,.35);
      background: rgba(255,92,122,.12);
    }

    .toggle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border:1px solid rgba(230,233,242,.16);
      border-radius: 12px;
      padding: 10px 10px;
      background: rgba(18,26,49,.25);
    }
    .toggle span{color:var(--muted)}
    .toggle input{width:auto; transform:scale(1.15)}

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(230,233,242,.18);
      background: rgba(18,26,49,.28);
      font-size:.86rem;
      margin: 2px 4px 2px 0;
    }
    .statgrid{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:10px;
    }
    .stat{
      border:1px solid rgba(230,233,242,.14);
      border-radius: 14px;
      padding: 10px;
      background: rgba(18,26,49,.25);
    }
    .stat .k{color:var(--muted2); font-size:.86rem}
    .stat .v{font-weight:850; font-size:1.18rem; margin-top:4px}

    .workbox{
      border:1px dashed rgba(230,233,242,.22);
      border-radius: 14px;
      padding: 12px;
      background: rgba(12,18,40,.35);
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      color: rgba(230,233,242,.92);
      line-height:1.35;
      min-height: 110px;
    }

    .choices{display:grid; gap:10px; margin-top:10px}
    .choice{
      text-align:left;
      padding: 10px;
      border-radius: 14px;
      background: rgba(18,26,49,.25);
      border:1px solid rgba(230,233,242,.16);
    }
    .choice:hover{filter: brightness(1.06)}
    .choice small{display:block; color:var(--muted2); margin-top:4px; line-height:1.35}

    .msg{
      margin-top:10px;
      border-radius: 14px;
      padding: 10px;
      border:1px solid rgba(230,233,242,.16);
      background: rgba(18,26,49,.25);
      color: var(--muted);
      line-height:1.4;
    }
    .msg.good{border-color: rgba(55,214,122,.35); background: rgba(55,214,122,.10); color: rgba(230,255,242,.96)}
    .msg.bad{border-color: rgba(255,92,122,.35); background: rgba(255,92,122,.10); color: rgba(255,240,244,.96)}
    .msg.warn{border-color: rgba(255,209,102,.35); background: rgba(255,209,102,.10); color: rgba(255,250,235,.96)}

    .divider{height:1px; background:rgba(230,233,242,.12); margin: 12px 0}

    .small{
      color:var(--muted2);
      font-size:.92rem;
      line-height:1.35;
    }

    .footer{
      margin-top: 14px;
      opacity:.92;
      font-size:.93rem;
      color:var(--muted2);
      line-height:1.4;
    }

    .list{
      margin: 0;
      padding-left: 18px;
      color: var(--muted);
      line-height: 1.5;
    }

    .right-actions{display:flex; gap:10px}
    .right-actions button{width:auto; padding: 10px 12px}

    /* Dyslexic-friendly font toggle */
    body.df{
      font-family: var(--font-alt);
      letter-spacing: .15px;
      word-spacing: .3px;
    }

    .version{
      font-size:.86rem;
      opacity:.8;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="name">üïµÔ∏è‚Äç‚ôÇÔ∏è BeTheMath: Error Detective</div>
        <div class="tag">Errors to Insight ‚Ä¢ Fix Mistakes Fast</div>
      </div>
      <div class="nav">
        <a class="pill" href="#trust">Trust & Safety</a>
        <a class="pill" href="#teacher">Teacher Instructions</a>
        <span class="pill version" id="verPill">v1.0</span>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT COLUMN -->
      <div>
        <div class="card" id="settingsCard">
          <h2>Session Settings</h2>
          <p class="subtitle">Choose player, grade band, and track (Operations ‚Ä¢ Reasoning ‚Ä¢ Logic & Patterns).</p>

          <div class="row tight">
            <div>
              <label for="playerSel">Player</label>
              <select id="playerSel"></select>
            </div>
            <div style="max-width:120px">
              <label>&nbsp;</label>
              <div class="right-actions">
                <button class="ghost" id="addPlayerBtn" title="Add player">Ôºã</button>
                <button class="ghost" id="delPlayerBtn" title="Remove player">Ôºç</button>
              </div>
            </div>
          </div>

          <div class="row tight" style="margin-top:10px">
            <div>
              <label for="gradeSel">Grade Band</label>
              <select id="gradeSel">
                <option>K‚Äì2</option>
                <option>3‚Äì5</option>
                <option>6‚Äì8</option>
                <option>Algebra I</option>
                <option>Geometry</option>
                <option>Algebra II</option>
                <option>Trigonometry</option>
                <option>Pre-Calc / Calc</option>
              </select>
            </div>
            <div>
              <label for="trackSel">Track</label>
              <select id="trackSel">
                <option>Operations</option>
                <option>Reasoning</option>
                <option>Logic & Patterns</option>
              </select>
            </div>
          </div>

          <div class="row tight" style="margin-top:10px">
            <div>
              <label for="explainRange">Explanation Time (sec): <span id="explainVal">2</span></label>
              <input id="explainRange" type="range" min="0" max="10" value="2" />
            </div>
            <div>
              <label for="scaleRange">UI Scale: <span id="scaleVal">100%</span></label>
              <input id="scaleRange" type="range" min="85" max="130" value="100" />
            </div>
          </div>

          <div class="divider"></div>

          <h3 style="margin-top:0">Accessibility</h3>
          <div class="row tight">
            <div class="toggle">
              <span>High contrast</span>
              <input id="hcToggle" type="checkbox" />
            </div>
            <div class="toggle">
              <span>Dyslexic-friendly font</span>
              <input id="dfToggle" type="checkbox" />
            </div>
          </div>

          <div class="row tight" style="margin-top:10px">
            <div class="toggle">
              <span>SFX: <strong id="sfxLabel">ON</strong></span>
              <input id="sfxToggle" type="checkbox" checked />
            </div>
            <div class="row tight" style="margin:0">
              <button class="danger" id="resetBtn" title="Reset current player's progress">Reset Progress</button>
            </div>
          </div>

          <div class="divider"></div>

          <div class="row tight">
            <button class="primary" id="readyBtn">Ready.</button>
            <div class="small" style="flex:1 1 60%">
              Player profiles and progress are stored only on this device (localStorage).
            </div>
          </div>
        </div>

        <div class="card" style="margin-top: var(--gap);">
          <h2>Current Challenge</h2>
          <div class="subtitle" id="challengeSub">Press <strong>Ready</strong> to begin.</div>

          <div class="workbox" id="studentWork">Student work will appear here.</div>

          <div class="choices" id="choices"></div>

          <div class="row tight" style="margin-top:10px">
            <button class="ghost" id="revealNowBtn">Reveal Explanation</button>
            <button class="primary" id="nextBtn">Next ‚ñ∂</button>
          </div>

          <div id="message" class="msg" style="display:none"></div>
        </div>
      </div>

      <!-- RIGHT COLUMN -->
      <div>
        <div class="card">
          <h2>Insights</h2>
          <p class="subtitle">Each time you fix an error, the insight appears here for quick review.</p>
          <div id="insights" class="small">No insights yet.</div>
        </div>

        <div class="card" style="margin-top: var(--gap);">
          <h2>Session Stats</h2>
          <div class="statgrid" style="margin-top:10px">
            <div class="stat"><div class="k">XP</div><div class="v" id="xp">0</div></div>
            <div class="stat"><div class="k">Coins</div><div class="v" id="coins">0</div></div>
            <div class="stat"><div class="k">Streak</div><div class="v" id="streak">0</div></div>
            <div class="stat"><div class="k">Played</div><div class="v" id="played">0</div></div>
          </div>
        </div>

        <div class="card" style="margin-top: var(--gap);">
          <h2>Badges</h2>
          <p class="subtitle">Earn badges for streaks, XP milestones, and building your Fix-It Queue.</p>
          <div id="badges" class="small">No badges yet.</div>
        </div>

        <div class="card" style="margin-top: var(--gap);">
          <h2>Scoreboard</h2>
          <p class="subtitle">Local players on this device, sorted by XP.</p>
          <div id="scoreboard" class="small">No players yet.</div>
          <div class="small" style="margin-top:8px">This scoreboard never leaves this browser. It is not shared online.</div>
        </div>

        <div class="card" id="teacher" style="margin-top: var(--gap);">
          <h2>Teacher Instructions</h2>
          <p class="subtitle">Quick guidance for using BeTheMath in class or at home.</p>
          <ul class="list">
            <li>Start with a short 5‚Äì10 minute warm-up: pick Grade Band + Track.</li>
            <li><strong>Operations:</strong> accuracy + fluency. <strong>Reasoning:</strong> explain why. <strong>Logic & Patterns:</strong> detect rules and contradictions.</li>
            <li>After a miss, pause and read the explanation together before moving on.</li>
            <li>Use the Fix-It Queue to review repeated errors later.</li>
            <li>Ask learners to justify their choice in words (even when correct).</li>
          </ul>
        </div>

        <div class="card" id="trust" style="margin-top: var(--gap);">
          <h2>Trust & Safety</h2>
          <p class="subtitle">Designed to help learners improve without tracking, pressure, or surprise paywalls.</p>
          <ul class="list">
            <li><strong>Purpose:</strong> Practice by diagnosing common errors and choosing the clean fix.</li>
            <li><strong>Privacy-first:</strong> No accounts. No ads. No tracking. Progress stays on your device.</li>
            <li><strong>Educational tool:</strong> Practice support‚Äînot a guarantee of outcomes.</li>
            <li><strong>Clarity:</strong> Explanations show the first wrong step and the correction.</li>
          </ul>

          <div class="divider"></div>
          <div class="footer">
            <strong>Privacy:</strong> Local-only storage (localStorage). No personal data collection.<br/>
            <strong>Terms:</strong> Educational practice tool. Use at your own pace.<br/>
            BeTheMath is not affiliated with other organizations with similar names.
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // BeTheMath: Error Detective ‚Äî v1.0
    // Self-contained build (no external files required)
    // Tracks: Operations | Reasoning | Logic & Patterns
    // =========================

    const APP_VERSION = "1.0";
    const LS_KEY = "bethemath_error_detective_v1";

    // Each item: gradeBand, track, title, studentWork, choices[{t,hint}], correctIndex, explanation, insight, tags[]
    const ERROR_BANK = [
      // -------------------------
      // K‚Äì2 ‚Äî OPERATIONS
      // -------------------------
      {
        gradeBand:"K‚Äì2", track:"Operations",
        title:"Counting on (addition)",
        studentWork:"Problem: 7 + 5\nStudent:\n7 + 5 = 11",
        choices:[
          {t:"Correct the sum to 12", hint:"Count on 5 from 7."},
          {t:"Correct the sum to 10", hint:"That would be 7 + 3."},
          {t:"Keep 11 because it 'looks right'", hint:"Always verify with counting or facts."},
        ],
        correctIndex:0,
        explanation:"First wrong step: 7 + 5 was computed as 11.\nClean fix: count on 5 from 7 ‚Üí 8,9,10,11,12 ‚Üí 12.",
        insight:"Counting-on helps you add without losing track.",
        tags:["addition","counting"]
      },
      {
        gradeBand:"K‚Äì2", track:"Operations",
        title:"Take-away subtraction",
        studentWork:"Problem: 14 ‚àí 6\nStudent:\n14 ‚àí 6 = 9",
        choices:[
          {t:"Correct the answer to 8", hint:"Take away 6 from 14."},
          {t:"Correct the answer to 7", hint:"That would be 14 ‚àí 7."},
          {t:"Keep 9 because 14 is bigger", hint:"Bigger doesn‚Äôt guarantee the difference."},
        ],
        correctIndex:0,
        explanation:"First wrong step: 14 ‚àí 6 was computed as 9.\nClean fix: 14 ‚àí 6 = 8.",
        insight:"Subtraction asks what‚Äôs left after taking away.",
        tags:["subtraction"]
      },

      // K‚Äì2 ‚Äî REASONING
      {
        gradeBand:"K‚Äì2", track:"Reasoning",
        title:"Which is larger?",
        studentWork:"Student says: 19 is larger than 21 because 9 is larger than 1.",
        choices:[
          {t:"Correct: 21 is larger than 19", hint:"Compare tens first."},
          {t:"Correct: 19 is larger than 21", hint:"That would only be true if 19 had more tens."},
          {t:"Both are the same", hint:"They are different numbers."},
        ],
        correctIndex:0,
        explanation:"First wrong step: compared ones digits instead of tens.\nClean fix: 21 has 2 tens; 19 has 1 ten ‚Üí 21 is larger.",
        insight:"In 2-digit numbers, tens place matters most.",
        tags:["place-value","comparison"]
      },

      // K‚Äì2 ‚Äî LOGIC & PATTERNS
      {
        gradeBand:"K‚Äì2", track:"Logic & Patterns",
        title:"Pattern rule (skip counting)",
        studentWork:"Pattern: 2, 4, 6, __, 10\nStudent fills in: 9",
        choices:[
          {t:"Correct: 8", hint:"The pattern adds 2 each time."},
          {t:"Correct: 7", hint:"That would add 1 sometimes."},
          {t:"Keep 9 because it‚Äôs near 10", hint:"Patterns follow a rule, not closeness."},
        ],
        correctIndex:0,
        explanation:"First wrong step: inserted a number that breaks the +2 rule.\nClean fix: 6 + 2 = 8.",
        insight:"A pattern is a rule you repeat.",
        tags:["patterns","skip-counting"]
      },
      {
        gradeBand:"K‚Äì2", track:"Logic & Patterns",
        title:"Odd/even rule check",
        studentWork:"Student says: ‚ÄúAll even numbers end in 2.‚Äù",
        choices:[
          {t:"Correct: Even numbers can end in 0,2,4,6,8", hint:"List possible last digits."},
          {t:"Correct: Even numbers end in 1", hint:"That would be odd."},
          {t:"Keep it because 2 is even", hint:"One example doesn‚Äôt prove a rule."},
        ],
        correctIndex:0,
        explanation:"First wrong step: made a rule from one example.\nClean fix: Even numbers end in 0,2,4,6,8.",
        insight:"A rule must work for every case, not just one.",
        tags:["logic","even-odd"]
      },

      // -------------------------
      // 3‚Äì5 ‚Äî OPERATIONS
      // -------------------------
      {
        gradeBand:"3‚Äì5", track:"Operations",
        title:"Regrouping across a zero",
        studentWork:"Problem: 402 ‚àí 178\nStudent:\n402 ‚àí 178 = 334",
        choices:[
          {t:"Correct: 224", hint:"Borrow across the 0 correctly."},
          {t:"Correct: 324", hint:"Check the hundreds place."},
          {t:"Keep 334 because 400‚àí200‚âà200", hint:"Estimates aren‚Äôt final answers."},
        ],
        correctIndex:0,
        explanation:"First wrong step: regrouping across the 0 was mishandled.\nClean fix: 402 ‚àí 178 = 224.",
        insight:"Zeros in the middle often require borrowing from farther left.",
        tags:["subtraction","regrouping"]
      },
      {
        gradeBand:"3‚Äì5", track:"Operations",
        title:"Multiplication fact check",
        studentWork:"Problem: 8 √ó 7\nStudent:\n8 √ó 7 = 54",
        choices:[
          {t:"Correct: 56", hint:"7√ó8=56."},
          {t:"Correct: 64", hint:"That‚Äôs 8√ó8."},
          {t:"Keep 54 because 8+7=15", hint:"Addition isn‚Äôt multiplication."},
        ],
        correctIndex:0,
        explanation:"First wrong step: 8√ó7 computed as 54.\nClean fix: 8√ó7=56.",
        insight:"If you know 7√ó8, you know 8√ó7 too.",
        tags:["multiplication"]
      },

      // 3‚Äì5 ‚Äî REASONING
      {
        gradeBand:"3‚Äì5", track:"Reasoning",
        title:"Estimation to catch an error",
        studentWork:"Problem: 198 + 203\nStudent:\n198 + 203 = 311",
        choices:[
          {t:"Correct: 401", hint:"Estimate ~200+200=400, then compute exactly."},
          {t:"Correct: 311", hint:"Does 311 match the estimate of ~400?"},
          {t:"Correct: 511", hint:"That‚Äôs too large compared to ~400."},
        ],
        correctIndex:0,
        explanation:"First wrong step: sum doesn‚Äôt match the estimate.\nClean fix: 198+203=401.",
        insight:"Quick estimates can catch arithmetic slips.",
        tags:["addition","estimation"]
      },

      // 3‚Äì5 ‚Äî LOGIC & PATTERNS
      {
        gradeBand:"3‚Äì5", track:"Logic & Patterns",
        title:"Number riddle (constraints)",
        studentWork:"Riddle: It‚Äôs an even number between 20 and 30.\nStudent answers: 27",
        choices:[
          {t:"Correct: 22, 24, 26, or 28 (any one)", hint:"Even numbers end in 0,2,4,6,8."},
          {t:"Correct: 27 (keep)", hint:"27 is odd."},
          {t:"Correct: 21", hint:"21 is odd."},
        ],
        correctIndex:0,
        explanation:"First wrong step: chose an odd number.\nClean fix: a valid answer is 22 (or 24/26/28).",
        insight:"Constraints must all be satisfied at once.",
        tags:["logic","constraints"]
      },
      {
        gradeBand:"3‚Äì5", track:"Logic & Patterns",
        title:"Pattern (growing by 3)",
        studentWork:"Pattern: 5, 8, 11, __, 17\nStudent fills in: 15",
        choices:[
          {t:"Correct: 14", hint:"The pattern adds 3."},
          {t:"Correct: 15", hint:"Check: 11+3 is 14, not 15."},
          {t:"Keep 15 because it‚Äôs near 17", hint:"Patterns follow a rule."},
        ],
        correctIndex:0,
        explanation:"First wrong step: broke the +3 rule.\nClean fix: 11 + 3 = 14.",
        insight:"Verify a pattern by checking consecutive differences.",
        tags:["patterns"]
      },

      // -------------------------
      // 6‚Äì8 ‚Äî OPERATIONS
      // -------------------------
      {
        gradeBand:"6‚Äì8", track:"Operations",
        title:"Integer subtraction",
        studentWork:"Problem: 5 ‚àí (‚àí3)\nStudent:\n5 ‚àí (‚àí3) = 2",
        choices:[
          {t:"Correct: 8", hint:"Subtracting a negative becomes addition."},
          {t:"Correct: ‚àí8", hint:"That would be ‚àí5 ‚àí 3."},
          {t:"Keep 2 because negatives cancel", hint:"Rule misapplied."},
        ],
        correctIndex:0,
        explanation:"First wrong step: treated subtraction of a negative as subtraction.\nClean fix: 5 ‚àí (‚àí3) = 5 + 3 = 8.",
        insight:"Subtracting a negative is the same as adding the positive.",
        tags:["integers"]
      },
      {
        gradeBand:"6‚Äì8", track:"Operations",
        title:"Fraction addition (common denominator)",
        studentWork:"Problem: 1/4 + 1/8\nStudent:\n= 2/12",
        choices:[
          {t:"Correct: 3/8", hint:"Convert 1/4 to 2/8 first."},
          {t:"Correct: 1/12", hint:"That‚Äôs not the right method."},
          {t:"Keep 2/12 because add tops and bottoms", hint:"Never add denominators directly."},
        ],
        correctIndex:0,
        explanation:"First wrong step: added denominators.\nClean fix: 1/4=2/8, so 2/8+1/8=3/8.",
        insight:"Fractions add by matching denominators.",
        tags:["fractions"]
      },

      // 6‚Äì8 ‚Äî REASONING
      {
        gradeBand:"6‚Äì8", track:"Reasoning",
        title:"Percent reasonableness",
        studentWork:"A shirt costs $50 and is 20% off.\nStudent says: discount is $20.",
        choices:[
          {t:"Correct: $10 off", hint:"20% of 50 is (0.2)(50)."},
          {t:"Correct: $20 off", hint:"That would be 40% off."},
          {t:"Correct: $5 off", hint:"That would be 10% off."},
        ],
        correctIndex:0,
        explanation:"First wrong step: computed 20% as 20 dollars.\nClean fix: 20% of 50 = 10, so price becomes $40.",
        insight:"Percent means ‚Äòout of 100‚Äô‚Äîconvert to a fraction or decimal.",
        tags:["percent"]
      },

      // 6‚Äì8 ‚Äî LOGIC & PATTERNS
      {
        gradeBand:"6‚Äì8", track:"Logic & Patterns",
        title:"Divisibility logic (implication)",
        studentWork:"Student says: ‚ÄúIf a number is divisible by 4, it is NOT always divisible by 2.‚Äù",
        choices:[
          {t:"Correct: If divisible by 4, it is always divisible by 2", hint:"4 = 2√ó2, so 4 goes into the number ‚áí 2 goes in too."},
          {t:"Keep the student statement", hint:"Try a counterexample: 12 is divisible by 4 and by 2."},
          {t:"Correct: It depends on the last digit only", hint:"Divisibility by 4 depends on last two digits."},
        ],
        correctIndex:0,
        explanation:"First wrong step: denied a true implication.\nClean fix: divisible by 4 guarantees divisible by 2.",
        insight:"If A implies B, you can test with counterexamples.",
        tags:["logic","number-theory"]
      },
      {
        gradeBand:"6‚Äì8", track:"Logic & Patterns",
        title:"Contradiction check",
        studentWork:"Rule: A number is both > 10 and < 5.\nStudent says: 7 works.",
        choices:[
          {t:"Correct: No number can satisfy both", hint:"A number can‚Äôt be greater than 10 and less than 5 at the same time."},
          {t:"Correct: 7 works", hint:"7 is not > 10."},
          {t:"Correct: 12 works", hint:"12 is not < 5."},
        ],
        correctIndex:0,
        explanation:"First wrong step: accepted a rule that contradicts itself.\nClean fix: there is no solution.",
        insight:"When conditions conflict, the solution set is empty.",
        tags:["logic","inequalities"]
      },

      // -------------------------
      // Algebra I ‚Äî OPERATIONS
      // -------------------------
      {
        gradeBand:"Algebra I", track:"Operations",
        title:"Distribute correctly",
        studentWork:"Problem: 3(x + 4)\nStudent:\n3x + 4",
        choices:[
          {t:"Correct: 3x + 12", hint:"Multiply 3 by both terms."},
          {t:"Correct: x + 12", hint:"That drops the 3 on x."},
          {t:"Keep 3x + 4", hint:"Parentheses go away only after distributing."},
        ],
        correctIndex:0,
        explanation:"First wrong step: distributed only to x.\nClean fix: 3(x+4)=3x+12.",
        insight:"Distribution multiplies every term inside parentheses.",
        tags:["distribution"]
      },
      {
        gradeBand:"Algebra I", track:"Operations",
        title:"Combine like terms",
        studentWork:"Problem: 2x + 5x ‚àí 3\nStudent:\n= 7x ‚àí 3x",
        choices:[
          {t:"Correct: 7x ‚àí 3", hint:"Only x-terms combine; constants stay."},
          {t:"Correct: 4x", hint:"You lost the constant."},
          {t:"Keep 7x ‚àí 3x", hint:"‚àí3 is not an x-term."},
        ],
        correctIndex:0,
        explanation:"First wrong step: treated ‚àí3 as an x-term.\nClean fix: 2x+5x=7x, so expression is 7x‚àí3.",
        insight:"Like terms must match variable and exponent.",
        tags:["like-terms"]
      },

      // Algebra I ‚Äî REASONING
      {
        gradeBand:"Algebra I", track:"Reasoning",
        title:"Solution check",
        studentWork:"Solve: x + 7 = 12\nStudent says: x = 6",
        choices:[
          {t:"Correct: x = 5", hint:"Check by substitution: 5+7=12."},
          {t:"Keep x = 6", hint:"Check: 6+7=13, not 12."},
          {t:"Correct: x = 19", hint:"That would make the left side too large."},
        ],
        correctIndex:0,
        explanation:"First wrong step: did not verify.\nClean fix: x=12‚àí7=5, and 5+7=12 checks.",
        insight:"Always verify a proposed solution by substitution.",
        tags:["equations","check"]
      },

      // Algebra I ‚Äî LOGIC & PATTERNS
      {
        gradeBand:"Algebra I", track:"Logic & Patterns",
        title:"If-then reasoning",
        studentWork:"Statement: If it rains, the ground gets wet.\nStudent says: ‚ÄúIf the ground is wet, it must have rained.‚Äù",
        choices:[
          {t:"Correct: That conclusion is not guaranteed", hint:"Wet ground could have other causes (sprinklers, etc.)."},
          {t:"Keep it because wet means rain", hint:"That assumes only one cause."},
          {t:"Correct: Both statements are identical", hint:"They are different (converse vs original)."},
        ],
        correctIndex:0,
        explanation:"First wrong step: treated a statement as if its converse must be true.\nClean fix: the converse may be false.",
        insight:"‚ÄòIf A then B‚Äô does not mean ‚ÄòIf B then A‚Äô.",
        tags:["logic","implication"]
      },

      // -------------------------
      // Geometry ‚Äî REASONING / LOGIC
      // -------------------------
      {
        gradeBand:"Geometry", track:"Reasoning",
        title:"Triangle angle sum",
        studentWork:"A triangle has angles 50¬∞ and 60¬∞.\nStudent: third angle = 120¬∞",
        choices:[
          {t:"Correct: 70¬∞", hint:"Triangle angles sum to 180¬∞."},
          {t:"Correct: 80¬∞", hint:"That would happen if the known sum were 100¬∞."},
          {t:"Keep 120¬∞", hint:"Check: 50+60+120=230, not 180."},
        ],
        correctIndex:0,
        explanation:"First wrong step: subtracted incorrectly from 180¬∞.\nClean fix: 50+60=110, then 180‚àí110=70.",
        insight:"Angle sums let you sanity-check quickly.",
        tags:["triangles","angle-sum"]
      },
      {
        gradeBand:"Geometry", track:"Logic & Patterns",
        title:"Category logic (subset)",
        studentWork:"Facts: All squares are rectangles. All rectangles are parallelograms.\nStudent says: Squares are NOT parallelograms.",
        choices:[
          {t:"Correct: Squares are parallelograms", hint:"Subset chain: square ‚äÇ rectangle ‚äÇ parallelogram."},
          {t:"Keep student statement", hint:"That would break the chain of facts."},
          {t:"Correct: Only some squares are parallelograms", hint:"All squares are rectangles, so all are parallelograms here."},
        ],
        correctIndex:0,
        explanation:"First wrong step: denied a conclusion that follows from the given categories.\nClean fix: squares are parallelograms under these facts.",
        insight:"If A ‚äÇ B and B ‚äÇ C, then A ‚äÇ C.",
        tags:["logic","sets"]
      },

      // -------------------------
      // Algebra II ‚Äî OPERATIONS / REASONING / LOGIC
      // -------------------------
      {
        gradeBand:"Algebra II", track:"Operations",
        title:"Exponent rules (product)",
        studentWork:"Problem: x^3 ¬∑ x^4\nStudent:\n= x^12",
        choices:[
          {t:"Correct: x^7", hint:"Multiply same base ‚Üí add exponents."},
          {t:"Correct: x^1", hint:"That would be division."},
          {t:"Keep x^12", hint:"3√ó4 is for (x^3)^4, not x^3¬∑x^4."},
        ],
        correctIndex:0,
        explanation:"First wrong step: multiplied exponents instead of adding.\nClean fix: x^3¬∑x^4 = x^(3+4)=x^7.",
        insight:"Same base multiply ‚Üí add exponents.",
        tags:["exponents"]
      },
      {
        gradeBand:"Algebra II", track:"Reasoning",
        title:"Quadratic roots check",
        studentWork:"Solve: x^2 = 9\nStudent says: x = 3 only",
        choices:[
          {t:"Correct: x = 3 and x = ‚àí3", hint:"Both squares equal 9."},
          {t:"Keep x=3 only", hint:"(‚àí3)^2 is also 9."},
          {t:"Correct: x=9", hint:"9^2 is 81."},
        ],
        correctIndex:0,
        explanation:"First wrong step: missed the negative solution.\nClean fix: x = ¬±3.",
        insight:"Even powers typically have two real solutions when positive.",
        tags:["quadratics"]
      },
      {
        gradeBand:"Algebra II", track:"Logic & Patterns",
        title:"Sequence pattern (explicit rule)",
        studentWork:"Sequence: 1, 4, 9, 16, __\nStudent says: 20",
        choices:[
          {t:"Correct: 25", hint:"These are perfect squares: 1^2,2^2,3^2,4^2,5^2."},
          {t:"Correct: 21", hint:"That‚Äôs adding 3,5,7 then add 9? check."},
          {t:"Keep 20", hint:"Check the pattern carefully."},
        ],
        correctIndex:0,
        explanation:"First wrong step: broke the square-number pattern.\nClean fix: next is 5^2 = 25.",
        insight:"Recognizing common sequences speeds reasoning.",
        tags:["patterns","sequences"]
      },

      // -------------------------
      // Trigonometry ‚Äî OPERATIONS / REASONING / LOGIC
      // -------------------------
      {
        gradeBand:"Trigonometry", track:"Operations",
        title:"Right-triangle sine definition",
        studentWork:"Right triangle: opposite=3, adjacent=4, hypotenuse=5.\nStudent: sin(Œ∏)=4/5",
        choices:[
          {t:"Correct: sin(Œ∏)=3/5", hint:"sin = opposite / hypotenuse."},
          {t:"Correct: sin(Œ∏)=5/3", hint:"That flips the ratio."},
          {t:"Keep 4/5", hint:"That ratio is cosine here."},
        ],
        correctIndex:0,
        explanation:"First wrong step: used adjacent/hypotenuse for sine.\nClean fix: sin(Œ∏)=opposite/hypotenuse=3/5.",
        insight:"SOH: sine = opposite √∑ hypotenuse.",
        tags:["trig","definitions"]
      },
      {
        gradeBand:"Trigonometry", track:"Operations",
        title:"Degrees to radians",
        studentWork:"Convert 60¬∞ to radians.\nStudent: 60¬∞ = œÄ/2",
        choices:[
          {t:"Correct: œÄ/3", hint:"Multiply by œÄ/180."},
          {t:"Correct: 2œÄ/3", hint:"That‚Äôs 120¬∞."},
          {t:"Keep œÄ/2", hint:"œÄ/2 is 90¬∞."},
        ],
        correctIndex:0,
        explanation:"First wrong step: used the wrong reference conversion.\nClean fix: 60√ó(œÄ/180)=œÄ/3.",
        insight:"Radians = degrees √ó (œÄ/180).",
        tags:["trig","radians"]
      },
      {
        gradeBand:"Trigonometry", track:"Reasoning",
        title:"Period of sin(2x)",
        studentWork:"Find the period of y = sin(2x).\nStudent: period = 2œÄ",
        choices:[
          {t:"Correct: œÄ", hint:"Period is 2œÄ/|b| for sin(bx)."},
          {t:"Correct: 4œÄ", hint:"That would be 2œÄ/0.5."},
          {t:"Keep 2œÄ", hint:"sin(x) has period 2œÄ, but sin(2x) is compressed."},
        ],
        correctIndex:0,
        explanation:"First wrong step: ignored the multiplier on x.\nClean fix: period = 2œÄ/2 = œÄ.",
        insight:"Multiplying x by 2 halves the period.",
        tags:["trig","graphs"]
      },
      {
        gradeBand:"Trigonometry", track:"Reasoning",
        title:"Unit circle value",
        studentWork:"Evaluate cos(œÄ).\nStudent: cos(œÄ)=1",
        choices:[
          {t:"Correct: ‚àí1", hint:"At œÄ, the point is (‚àí1,0)."},
          {t:"Correct: 0", hint:"That‚Äôs cos(œÄ/2)."},
          {t:"Keep 1", hint:"Cosine can be negative."},
        ],
        correctIndex:0,
        explanation:"First wrong step: assumed cosine can‚Äôt be negative.\nClean fix: cos(œÄ)=‚àí1.",
        insight:"On unit circle: cos is x-coordinate.",
        tags:["trig","unit-circle"]
      },
      {
        gradeBand:"Trigonometry", track:"Logic & Patterns",
        title:"Quadrant sign logic",
        studentWork:"Angle is in Quadrant III.\nStudent: sin(Œ∏) is positive.",
        choices:[
          {t:"Correct: sin is negative in Quadrant III", hint:"In QIII, both x and y are negative."},
          {t:"Keep it because sine is always positive", hint:"Sine depends on y-coordinate."},
          {t:"Correct: sin is zero in QIII", hint:"Zero happens on axes only."},
        ],
        correctIndex:0,
        explanation:"First wrong step: used a false ‚Äòalways positive‚Äô rule.\nClean fix: Quadrant III has y<0, so sin(Œ∏)<0.",
        insight:"Quadrants determine trig signs quickly.",
        tags:["trig","signs","logic"]
      },

      // -------------------------
      // Pre-Calc / Calc ‚Äî OPERATIONS / REASONING / LOGIC
      // -------------------------
      {
        gradeBand:"Pre-Calc / Calc", track:"Operations",
        title:"Function evaluation (watch parentheses)",
        studentWork:"Given f(x)=2x‚àí5.\nStudent: f(3)=2(3‚àí5)=‚àí4",
        choices:[
          {t:"Correct: 1", hint:"Substitute x=3: 2¬∑3‚àí5."},
          {t:"Keep ‚àí4", hint:"That used parentheses not present."},
          {t:"Correct: 11", hint:"That would be 2¬∑3+5."},
        ],
        correctIndex:0,
        explanation:"First wrong step: rewrote 2x‚àí5 as 2(x‚àí5).\nClean fix: f(3)=2¬∑3‚àí5=6‚àí5=1.",
        insight:"Don‚Äôt invent parentheses‚Äîfollow the given expression.",
        tags:["functions"]
      },
      {
        gradeBand:"Pre-Calc / Calc", track:"Reasoning",
        title:"Average rate of change",
        studentWork:"From x=1 to x=3, f(1)=2 and f(3)=10.\nStudent: average rate is 8/1 = 8",
        choices:[
          {t:"Correct: 4", hint:"(10‚àí2)/(3‚àí1)=8/2."},
          {t:"Keep 8", hint:"Denominator should be change in x (2), not 1."},
          {t:"Correct: 12", hint:"That‚Äôs adding, not dividing."},
        ],
        correctIndex:0,
        explanation:"First wrong step: used the wrong change in x.\nClean fix: (10‚àí2)/(3‚àí1)=8/2=4.",
        insight:"Average rate of change is slope between two points.",
        tags:["functions","slope"]
      },
      {
        gradeBand:"Pre-Calc / Calc", track:"Logic & Patterns",
        title:"Domain logic",
        studentWork:"Expression: ‚àö(x‚àí4)\nStudent says: x can be any real number.",
        choices:[
          {t:"Correct: x ‚â• 4", hint:"Radicand must be ‚â• 0 for real outputs."},
          {t:"Correct: x ‚â§ 4", hint:"That would make x‚àí4 ‚â§ 0."},
          {t:"Keep any real number", hint:"Square root of negative isn‚Äôt real (in this setting)."},
        ],
        correctIndex:0,
        explanation:"First wrong step: ignored the square root restriction.\nClean fix: require x‚àí4 ‚â• 0, so x ‚â• 4.",
        insight:"Domain rules prevent impossible operations.",
        tags:["domain","logic"]
      },
    ];

    // --- State
    const state = {
      ready: false,
      current: null,
      lastRevealTimer: null,
      revealDelaySec: 2,
      uiScale: 100,
      sfx: true,
      highContrast: false,
      dyslexicFont: false,
      player: null,
      gradeBand: "6‚Äì8",
      track: "Operations",
      message: { show:false, kind:"", text:"" }
    };

    // --- DOM
    const $ = (id)=>document.getElementById(id);

    const playerSel = $("playerSel");
    const gradeSel  = $("gradeSel");
    const trackSel  = $("trackSel");
    const explainRange = $("explainRange");
    const explainVal = $("explainVal");
    const scaleRange = $("scaleRange");
    const scaleVal = $("scaleVal");
    const hcToggle = $("hcToggle");
    const dfToggle = $("dfToggle");
    const sfxToggle = $("sfxToggle");
    const sfxLabel  = $("sfxLabel");

    const readyBtn = $("readyBtn");
    const resetBtn = $("resetBtn");
    const addPlayerBtn = $("addPlayerBtn");
    const delPlayerBtn = $("delPlayerBtn");

    const studentWork = $("studentWork");
    const choicesEl = $("choices");
    const messageEl = $("message");
    const challengeSub = $("challengeSub");

    const nextBtn = $("nextBtn");
    const revealNowBtn = $("revealNowBtn");

    const insightsEl = $("insights");
    const badgesEl = $("badges");
    const scoreboardEl = $("scoreboard");

    const xpEl = $("xp");
    const coinsEl = $("coins");
    const streakEl = $("streak");
    const playedEl = $("played");

    $("verPill").textContent = "v" + APP_VERSION;

    // --- Storage model
    function loadStore(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return { players: {}, lastPlayer: null, settings:{} };
        const parsed = JSON.parse(raw);
        if(!parsed.players) parsed.players = {};
        if(!parsed.settings) parsed.settings = {};
        return parsed;
      }catch(e){
        return { players: {}, lastPlayer: null, settings:{} };
      }
    }
    function saveStore(store){
      localStorage.setItem(LS_KEY, JSON.stringify(store));
    }

    function ensureDefaultPlayer(store){
      const names = Object.keys(store.players);
      if(names.length === 0){
        store.players["Player 1"] = freshProfile("Player 1");
        store.lastPlayer = "Player 1";
        saveStore(store);
      }
    }

    function freshProfile(name){
      return {
        name,
        xp: 0,
        coins: 0,
        streak: 0,
        played: 0,
        insights: [],
        badges: [],
        fixItQueue: [],
        createdAt: Date.now(),
        updatedAt: Date.now(),
      };
    }

    // --- UI helpers
    function setMessage(kind, text, show=true){
      state.message = {show, kind, text};
      messageEl.style.display = show ? "block" : "none";
      messageEl.className = "msg " + (kind || "");
      messageEl.textContent = text || "";
    }

    function beep(){
      if(!state.sfx) return;
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.connect(g);
        g.connect(ctx.destination);
        o.type = "sine";
        o.frequency.value = 660;
        g.gain.value = 0.04;
        o.start();
        setTimeout(()=>{ o.stop(); ctx.close(); }, 80);
      }catch(e){}
    }

    function badgeIf(profile, key, label){
      if(profile.badges.includes(key)) return false;
      profile.badges.push(key);
      profile.updatedAt = Date.now();
      setMessage("good", "üèÖ Badge earned: " + label);
      beep();
      return true;
    }

    function updateBadges(profile){
      if(profile.played >= 1) badgeIf(profile, "first_fix", "First Fix");
      if(profile.streak >= 3) badgeIf(profile, "streak_3", "Streak x3");
      if(profile.streak >= 10) badgeIf(profile, "streak_10", "Streak x10");
      if(profile.xp >= 100) badgeIf(profile, "xp_100", "XP 100");
      if((profile.fixItQueue || []).length >= 5) badgeIf(profile, "fixit_5", "Fix-It Builder (5)");
    }

    function prettyBadge(key){
      const map = {
        first_fix: "First Fix",
        streak_3: "Streak x3",
        streak_10:"Streak x10",
        xp_100:"XP 100",
        fixit_5:"Fix-It Builder (5)"
      };
      return map[key] || key;
    }

    function escapeHtml(s){
      return (s||"").replace(/[&<>"']/g, (c)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
      }[c]));
    }

    function renderProfile(profile){
      xpEl.textContent = profile.xp || 0;
      coinsEl.textContent = profile.coins || 0;
      streakEl.textContent = profile.streak || 0;
      playedEl.textContent = profile.played || 0;

      if((profile.insights || []).length === 0){
        insightsEl.textContent = "No insights yet.";
      }else{
        insightsEl.innerHTML = profile.insights.slice(-10).reverse()
          .map((x)=>`<span class="badge">üí° ${escapeHtml(x)}</span>`).join("");
      }

      if((profile.badges || []).length === 0){
        badgesEl.textContent = "No badges yet.";
      }else{
        badgesEl.innerHTML = profile.badges
          .slice(0, 18)
          .map((b)=>`<span class="badge">üèÖ ${escapeHtml(prettyBadge(b))}</span>`)
          .join("");
      }
    }

    function renderScoreboard(store){
      const rows = Object.values(store.players)
        .sort((a,b)=> (b.xp||0) - (a.xp||0))
        .slice(0, 10);

      if(rows.length === 0){
        scoreboardEl.textContent = "No players yet.";
        return;
      }
      scoreboardEl.innerHTML = rows.map((p,i)=>{
        const star = (state.player && p.name === state.player.name) ? " ‚≠ê" : "";
        return `<div class="row tight" style="margin:6px 0">
          <div style="flex:1 1 auto"><strong>${i+1}.</strong> ${escapeHtml(p.name)}${star}</div>
          <div style="max-width:110px; text-align:right"><span class="badge">XP ${p.xp||0}</span></div>
        </div>`;
      }).join("");
    }

    function pickNextQuestion(){
      const pool = ERROR_BANK.filter(q => q.gradeBand === state.gradeBand && q.track === state.track);
      const fallback = ERROR_BANK.filter(q => q.track === state.track);

      const use = pool.length ? pool : fallback;
      if(!use.length) return null;

      let q = use[Math.floor(Math.random() * use.length)];
      if(state.current && use.length > 1){
        let tries = 0;
        while(q.title === state.current.title && tries < 6){
          q = use[Math.floor(Math.random() * use.length)];
          tries++;
        }
      }
      return q;
    }

    function clearChoices(){
      choicesEl.innerHTML = "";
    }

    function renderQuestion(q){
      clearChoices();
      setMessage("", "", false);

      if(!q){
        studentWork.textContent = "No questions available for this selection yet.";
        challengeSub.innerHTML = "Try a different grade band or track.";
        return;
      }

      challengeSub.innerHTML = `<strong>${escapeHtml(q.title)}</strong> ‚Ä¢ Pick the best explanation or fix for the student‚Äôs work.`;
      studentWork.textContent = q.studentWork;

      q.choices.forEach((c, idx)=>{
        const btn = document.createElement("button");
        btn.className = "choice";
        btn.innerHTML = `<strong>${escapeHtml(c.t)}</strong><small>${escapeHtml(c.hint||"")}</small>`;
        btn.addEventListener("click", ()=>submitChoice(idx));
        choicesEl.appendChild(btn);
      });
    }

    function scheduleReveal(text){
      if(state.lastRevealTimer) clearTimeout(state.lastRevealTimer);
      if(state.revealDelaySec <= 0) {
        setMessage("warn", text);
        return;
      }
      state.lastRevealTimer = setTimeout(()=> setMessage("warn", text), state.revealDelaySec * 1000);
    }

    function submitChoice(index){
      if(!state.ready || !state.current || !state.player) return;

      const store = loadStore();
      const profile = store.players[state.player.name];
      if(!profile) return;

      profile.played = (profile.played || 0) + 1;

      const correct = (index === state.current.correctIndex);

      if(correct){
        profile.xp = (profile.xp || 0) + 10;
        profile.coins = (profile.coins || 0) + 1;
        profile.streak = (profile.streak || 0) + 1;

        if(state.current.insight){
          profile.insights = profile.insights || [];
          profile.insights.push(state.current.insight);
          if(profile.insights.length > 60) profile.insights = profile.insights.slice(-60);
        }

        setMessage("good", "‚úÖ Correct! +10 XP, +1 coin.");
        beep();
      }else{
        profile.streak = 0;

        profile.fixItQueue = profile.fixItQueue || [];
        profile.fixItQueue.push({
          title: state.current.title,
          gradeBand: state.current.gradeBand,
          track: state.current.track,
          ts: Date.now()
        });
        if(profile.fixItQueue.length > 40) profile.fixItQueue = profile.fixItQueue.slice(-40);

        setMessage("bad", "‚ùå Not quite. Adding this to your Fix-It Queue.");
      }

      profile.updatedAt = Date.now();
      updateBadges(profile);

      scheduleReveal(state.current.explanation || "Explanation unavailable.");

      store.players[state.player.name] = profile;
      store.lastPlayer = state.player.name;
      saveStore(store);

      state.player = profile;
      renderProfile(profile);
      renderScoreboard(store);
    }

    function nextQuestion(){
      if(!state.ready){
        setMessage("warn", "Press Ready to begin.");
        return;
      }
      state.current = pickNextQuestion();
      renderQuestion(state.current);
    }

    function revealNow(){
      if(!state.current) return;
      setMessage("warn", state.current.explanation || "Explanation unavailable.");
      beep();
    }

    function setScale(pct){
      state.uiScale = pct;
      document.documentElement.style.setProperty("--scale", pct + "%");
      scaleVal.textContent = pct + "%";
    }

    function applyToggles(){
      document.body.classList.toggle("hc", !!state.highContrast);
      document.body.classList.toggle("df", !!state.dyslexicFont);
      sfxLabel.textContent = state.sfx ? "ON" : "OFF";
    }

    function refreshPlayersUI(store){
      const names = Object.keys(store.players).sort((a,b)=>a.localeCompare(b));
      playerSel.innerHTML = "";
      names.forEach(n=>{
        const opt = document.createElement("option");
        opt.value = n;
        opt.textContent = n;
        playerSel.appendChild(opt);
      });
      if(store.lastPlayer && store.players[store.lastPlayer]){
        playerSel.value = store.lastPlayer;
      }else if(names.length){
        playerSel.value = names[0];
      }
      selectPlayer(playerSel.value, store);
    }

    function selectPlayer(name, store){
      const p = store.players[name];
      if(!p) return;
      state.player = p;
      renderProfile(p);
      renderScoreboard(store);
    }

    function resetCurrentPlayer(){
      const store = loadStore();
      const name = playerSel.value;
      if(!name || !store.players[name]) return;

      const ok = confirm(`Reset progress for "${name}"? This only affects this device/browser.`);
      if(!ok) return;

      store.players[name] = freshProfile(name);
      store.lastPlayer = name;
      saveStore(store);

      state.player = store.players[name];
      renderProfile(state.player);
      renderScoreboard(store);

      setMessage("warn", "Progress reset for " + name + ".");
      beep();
    }

    function addPlayer(){
      const store = loadStore();
      const name = prompt("New player name (local only):");
      if(!name) return;
      const clean = name.trim().slice(0, 24);
      if(!clean) return;
      if(store.players[clean]){
        alert("That player already exists.");
        return;
      }
      store.players[clean] = freshProfile(clean);
      store.lastPlayer = clean;
      saveStore(store);
      refreshPlayersUI(store);
      setMessage("good", "Player created: " + clean);
      beep();
    }

    function deletePlayer(){
      const store = loadStore();
      const name = playerSel.value;
      if(!name) return;

      const ok = confirm(`Delete "${name}" from this device? This cannot be undone.`);
      if(!ok) return;

      delete store.players[name];
      if(store.lastPlayer === name) store.lastPlayer = null;
      ensureDefaultPlayer(store);
      saveStore(store);
      refreshPlayersUI(store);
      setMessage("warn", "Player deleted.");
      beep();
    }

    function startSession(){
      state.ready = true;

      const store = loadStore();
      store.settings = store.settings || {};
      store.settings.gradeBand = state.gradeBand;
      store.settings.track = state.track;
      store.settings.revealDelaySec = state.revealDelaySec;
      store.settings.uiScale = state.uiScale;
      store.settings.highContrast = state.highContrast;
      store.settings.dyslexicFont = state.dyslexicFont;
      store.settings.sfx = state.sfx;
      store.lastPlayer = state.player ? state.player.name : store.lastPlayer;
      saveStore(store);

      setMessage("good", "Session started. Think like an error detective!");
      nextQuestion();
    }

    // --- Wire events
    gradeSel.addEventListener("change", ()=>{
      state.gradeBand = gradeSel.value;
      if(state.ready) nextQuestion();
    });
    trackSel.addEventListener("change", ()=>{
      state.track = trackSel.value;
      if(state.ready) nextQuestion();
    });

    explainRange.addEventListener("input", ()=>{
      state.revealDelaySec = parseInt(explainRange.value, 10);
      explainVal.textContent = state.revealDelaySec;
    });

    scaleRange.addEventListener("input", ()=>{
      setScale(parseInt(scaleRange.value, 10));
    });

    hcToggle.addEventListener("change", ()=>{
      state.highContrast = hcToggle.checked;
      applyToggles();
    });

    dfToggle.addEventListener("change", ()=>{
      state.dyslexicFont = dfToggle.checked;
      applyToggles();
    });

    sfxToggle.addEventListener("change", ()=>{
      state.sfx = sfxToggle.checked;
      applyToggles();
    });

    readyBtn.addEventListener("click", startSession);
    resetBtn.addEventListener("click", resetCurrentPlayer);
    addPlayerBtn.addEventListener("click", addPlayer);
    delPlayerBtn.addEventListener("click", deletePlayer);

    playerSel.addEventListener("change", ()=>{
      const store = loadStore();
      store.lastPlayer = playerSel.value;
      saveStore(store);
      selectPlayer(playerSel.value, store);
    });

    nextBtn.addEventListener("click", ()=>{ beep(); nextQuestion(); });
    revealNowBtn.addEventListener("click", revealNow);

    // --- Initialize
    (function init(){
      const store = loadStore();
      ensureDefaultPlayer(store);

      const s = store.settings || {};
      state.gradeBand = s.gradeBand || gradeSel.value;
      state.track = s.track || trackSel.value;
      state.revealDelaySec = Number.isFinite(s.revealDelaySec) ? s.revealDelaySec : 2;
      state.uiScale = Number.isFinite(s.uiScale) ? s.uiScale : 100;
      state.highContrast = !!s.highContrast;
      state.dyslexicFont = !!s.dyslexicFont;
      state.sfx = (s.sfx === false) ? false : true;

      gradeSel.value = state.gradeBand;
      trackSel.value = state.track;

      explainRange.value = String(state.revealDelaySec);
      explainVal.textContent = state.revealDelaySec;

      scaleRange.value = String(state.uiScale);
      setScale(state.uiScale);

      hcToggle.checked = state.highContrast;
      dfToggle.checked = state.dyslexicFont;
      sfxToggle.checked = state.sfx;
      applyToggles();

      saveStore(store);
      refreshPlayersUI(store);
      renderScoreboard(store);

      state.current = pickNextQuestion();
      renderQuestion(state.current);
      setMessage("warn", "Press Ready to begin.");
    })();
  </script>
</body>
</html>
