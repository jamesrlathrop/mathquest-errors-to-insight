<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BeTheMath ‚Äî Error Detective</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --mq-bg: #020617;
      --mq-panel: #020617;
      --mq-accent: #22c55e;
      --mq-accent-soft: rgba(34, 197, 94, 0.12);
      --mq-border: #1f2937;
      --mq-text: #e5e7eb;
      --mq-muted: #9ca3af;
      --mq-scale: 1;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #020617 0, #020617 50%, #000 100%);
      color: var(--mq-text);
    }

    /* High contrast */
    body.mq-high-contrast {
      background: #000 !important;
      color: #fff !important;
    }
    body.mq-high-contrast .mq-topbar,
    body.mq-high-contrast .mq-shell {
      background: #000 !important;
    }
    body.mq-high-contrast .mq-panel,
    body.mq-high-contrast .mq-game-card {
      background: #000 !important;
      border-color: #ffffff !important;
      box-shadow: none !important;
    }
    body.mq-high-contrast .mq-question-text,
    body.mq-high-contrast .mq-work,
    body.mq-high-contrast .mq-panel-title,
    body.mq-high-contrast .mq-panel-sub,
    body.mq-high-contrast .mq-stat-pill,
    body.mq-high-contrast .mq-stat-value,
    body.mq-high-contrast .mq-badge-chip,
    body.mq-high-contrast .mq-footer-note,
    body.mq-high-contrast #mq-queue-note,
    body.mq-high-contrast #mq-scoreboard {
      color: #ffffff !important;
      border-color: #ffffff !important;
    }
    body.mq-high-contrast .mq-option-btn {
      background: #000000 !important;
      color: #ffffff !important;
      border-color: #ffffff !important;
    }
    body.mq-high-contrast .mq-option-btn.mq-correct {
      background: #00ff00 !important;
      color: #000000 !important;
      border-color: #00ff00 !important;
    }
    body.mq-high-contrast .mq-option-btn.mq-incorrect {
      background: #ff0033 !important;
      color: #ffffff !important;
      border-color: #ff0033 !important;
    }
    body.mq-high-contrast .mq-small-btn,
    body.mq-high-contrast .mq-reset-btn {
      background: #000000 !important;
      color: #ffffff !important;
      border-color: #ffffff !important;
    }
    body.mq-high-contrast .mq-modebar {
      border-color: #ffffff !important;
    }
    body.mq-high-contrast .mq-mode-btn {
      color: #ffffff !important;
    }
    body.mq-high-contrast .mq-mode-btn-active {
      background: #ffffff !important;
      color: #000000 !important;
    }

    /* Dyslexic mode */
    body.mq-dyslexic {
      font-family: "OpenDyslexic", "Comic Sans MS", "Arial Rounded MT Bold",
        system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      line-height: 1.5;
    }
    body.mq-dyslexic #mq-root { letter-spacing: 0.02em; }

    #mq-root {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      transform-origin: top center;
      transform: scale(var(--mq-scale));
    }

    .mq-topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 16px;
      border-bottom: 1px solid var(--mq-border);
      background: #020617;
      position: sticky;
      top: 0;
      z-index: 20;
    }

    .mq-topbar-title {
      font-weight: 650;
      letter-spacing: 0.02em;
      font-size: 14px;
      color: #e5e7eb;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .mq-topbar-title .mq-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--mq-accent);
      box-shadow: 0 0 0 4px rgba(34,197,94,0.12);
      display: inline-block;
    }

    .mq-modebar {
      display: inline-flex;
      gap: 4px;
      border-radius: 999px;
      padding: 2px;
      background: #020617;
      border: 1px solid #1f2937;
    }

    .mq-mode-btn {
      border: none;
      background: transparent;
      color: #9ca3af;
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      cursor: default;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .mq-mode-btn-active {
      background: var(--mq-accent-soft);
      color: #bbf7d0;
      font-weight: 650;
    }

    .mq-shell {
      display: flex;
      flex: 1;
      padding: 12px;
      gap: 12px;
    }

    .mq-column {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .mq-column-left {
      width: 260px;
      max-width: 35%;
    }
    .mq-column-center {
      flex: 1;
      min-width: 0;
    }
    .mq-column-right {
      width: 260px;
      max-width: 35%;
    }

    @media (max-width: 900px) {
      .mq-shell { flex-direction: column; }
      .mq-column-left,
      .mq-column-right {
        width: 100%;
        max-width: 100%;
      }
    }

    .mq-panel {
      background: rgba(15, 23, 42, 0.95);
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.22);
      padding: 10px 12px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.7);
    }

    .mq-panel-title {
      font-size: 13px;
      font-weight: 650;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #9ca3af;
      margin-bottom: 6px;
    }

    .mq-panel-sub {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 8px;
    }

    .mq-field {
      margin-bottom: 8px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .mq-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: #9ca3af;
    }

    .mq-player-row {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .mq-player-row select { flex: 1; }

    select,
    input[type="range"] {
      width: 100%;
      padding: 4px 6px;
      border-radius: 8px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      font-size: 13px;
    }

    .mq-toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .mq-toggle-row label {
      font-size: 12px;
      color: #9ca3af;
    }

    .mq-toggle-row input[type="checkbox"] { transform: scale(1.1); }

    .mq-game-card {
      background: rgba(15, 23, 42, 0.95);
      border-radius: 20px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      padding: 14px 16px 16px;
      box-shadow: 0 22px 50px rgba(15, 23, 42, 0.8);
    }

    .mq-game-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .mq-game-title {
      font-size: 14px;
      font-weight: 650;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #9ca3af;
    }

    #game-container {
      width: 100%;
      height: 180px;
      border-radius: 16px;
      border: 1px solid #1f2937;
      background: radial-gradient(circle at top, #020617 0, #020617 50%, #000 100%);
      margin-bottom: 10px;
      overflow: hidden;
    }

    .mq-question-text {
      font-size: 14px;
      margin-bottom: 6px;
      color: #e5e7eb;
    }

    .mq-work {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 13px;
      padding: 6px 8px;
      border-radius: 8px;
      background: #020617;
      border: 1px solid #111827;
      color: #e5e7eb;
      margin-bottom: 6px;
      white-space: pre-wrap;
    }

    .mq-options {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 6px;
      margin-bottom: 8px;
    }

    .mq-option-btn {
      text-align: left;
      border-radius: 10px;
      border: 1px solid #1f2937;
      padding: 8px 10px;
      background: #020617;
      color: #e5e7eb;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.14s ease, border-color 0.14s ease, transform 0.07s ease;
    }

    .mq-option-btn:hover:not(:disabled) {
      background: #020617;
      border-color: #334155;
      transform: translateY(-1px);
    }

    .mq-option-btn:disabled {
      opacity: 0.86;
      cursor: default;
    }

    .mq-option-btn.mq-correct {
      background: rgba(34, 197, 94, 0.12);
      border-color: #22c55e;
    }

    .mq-option-btn.mq-incorrect {
      background: rgba(239, 68, 68, 0.12);
      border-color: #f97373;
    }

    .mq-feedback {
      font-size: 12px;
      color: #9ca3af;
      min-height: 18px;
    }

    .mq-feedback-correct { color: #bbf7d0; }
    .mq-feedback-encouraging { color: #facc15; }

    .mq-queue-note {
      font-size: 11px;
      color: #6b7280;
      margin-top: 2px;
    }

    .mq-insight-log {
      font-size: 11px;
      color: #9ca3af;
      max-height: 140px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .mq-badges-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .mq-badge-chip {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      color: #9ca3af;
      background: #020617;
      white-space: nowrap;
    }

    .mq-badge-earned {
      background: rgba(34, 197, 94, 0.16);
      color: #bbf7d0;
      border-color: #22c55e;
    }

    .mq-stat-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }

    .mq-stat-pill {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid #1f2937;
      color: #9ca3af;
    }

    .mq-stat-value {
      color: #e5e7eb;
      font-weight: 550;
      margin-left: 4px;
    }

    .mq-reset-btn,
    .mq-small-btn {
      border-radius: 999px;
      border: 1px solid #1f2937;
      padding: 4px 10px;
      background: #020617;
      color: #e5e7eb;
      font-size: 11px;
      cursor: pointer;
    }

    .mq-reset-btn:hover,
    .mq-small-btn:hover { background: #111827; }

    .mq-reset-btn {
      border-color: #f97373;
      color: #fecaca;
    }

    .mq-sfx-on {
      border-color: #22c55e;
      color: #bbf7d0;
    }

    .mq-footer-note {
      font-size: 10px;
      color: #6b7280;
      margin-top: 4px;
      line-height: 1.35;
    }
  </style>
</head>

<body>
  <div id="mq-root">
    <!-- Top bar -->
    <div class="mq-topbar">
      <div class="mq-topbar-title">
        <span class="mq-dot"></span>
        BeTheMath ‚Äî Error Detective
      </div>
      <div class="mq-modebar" aria-label="Mode">
        <span class="mq-mode-btn mq-mode-btn-active" title="Math mode only (for now)">
          üß† Math
        </span>
      </div>
    </div>

    <div class="mq-shell">
      <!-- Left column: controls -->
      <div class="mq-column mq-column-left">
        <div class="mq-panel">
          <div class="mq-panel-title">Session Settings</div>
          <div class="mq-panel-sub">Choose player, grade band, and track. Everything saves locally on this device.</div>

          <div class="mq-field">
            <span class="mq-label">Player</span>
            <div class="mq-player-row">
              <select id="mq-player"></select>
              <button id="mq-player-add" type="button" class="mq-small-btn" title="Add player">+</button>
              <button id="mq-player-delete" type="button" class="mq-small-btn" title="Delete player">‚Äì</button>
            </div>
          </div>

          <div class="mq-field">
            <span class="mq-label">Grade Band</span>
            <select id="mq-grade">
              <option value="K-2">K‚Äì2</option>
              <option value="3-5">3‚Äì5</option>
              <option value="6-8">6‚Äì8</option>
              <option value="Alg1">Algebra I</option>
              <option value="Geo">Geometry</option>
              <option value="Alg2">Algebra II</option>
              <option value="Trig">Trigonometry</option>
              <option value="PreCalc">Pre-Calculus</option>
              <option value="Calc">Calculus</option>
            </select>
          </div>

          <div class="mq-field">
            <span class="mq-label">Track</span>
            <select id="mq-track">
              <option value="operations">Operations</option>
              <option value="reasoning">Reasoning</option>
              <option value="logic">Logic &amp; Patterns</option>
            </select>
          </div>

          <div class="mq-field">
            <span class="mq-label">Auto-advance (sec)</span>
            <input id="mq-delay" type="range" min="3" max="20" value="5" />
          </div>

          <div class="mq-field">
            <span class="mq-label">UI Scale</span>
            <input id="mq-scale" type="range" min="80" max="130" value="100" />
          </div>

          <div class="mq-panel-sub">Accessibility</div>

          <div class="mq-toggle-row">
            <label for="mq-high-contrast">High contrast</label>
            <input id="mq-high-contrast" type="checkbox" />
          </div>
          <div class="mq-toggle-row">
            <label for="mq-dyslexic">Dyslexic-friendly font</label>
            <input id="mq-dyslexic" type="checkbox" />
          </div>

          <div style="margin-top: 8px; display: flex; gap: 6px; flex-wrap: wrap;">
            <button id="mq-sfx-toggle" type="button" class="mq-small-btn">SFX: ON</button>
            <button id="mq-reset" type="button" class="mq-reset-btn">Reset Progress</button>
          </div>

          <div class="mq-footer-note" id="mq-autosave">Ready.</div>
          <div class="mq-footer-note">
            ‚úÖ No accounts ‚Ä¢ ‚úÖ No ads ‚Ä¢ ‚úÖ No tracking<br />
            Player profiles and progress are stored only on this device (localStorage).
          </div>
        </div>
      </div>

      <!-- Center column: main game -->
      <div class="mq-column mq-column-center">
        <div class="mq-game-card">
          <div class="mq-game-header">
            <div class="mq-game-title">Current Challenge</div>
            <div style="font-size: 11px; color: #6b7280;" id="mq-queue-note">Loading your first error‚Ä¶</div>
          </div>

          <div id="game-container" aria-hidden="true"></div>

          <div class="mq-question-text" id="mq-question">Loading your first error‚Ä¶</div>
          <div class="mq-work" id="mq-work">Student work will appear here.</div>

          <div class="mq-options" id="mq-options"></div>

          <div class="mq-feedback" id="mq-feedback">Pick the best explanation or fix for the student's work.</div>

          <div style="margin-top: 6px; display: flex; justify-content: flex-end;">
            <button id="mq-next" type="button" class="mq-small-btn" disabled>Next ‚ñ∂</button>
          </div>
        </div>

        <div class="mq-panel" style="margin-top: 10px;">
          <div class="mq-panel-title">Insights</div>
          <div class="mq-panel-sub">Each time you fix an error, the insight appears here for quick review.</div>
          <div class="mq-insight-log" id="mq-insight-log"></div>
        </div>
      </div>

      <!-- Right column: stats, badges, scoreboard, teacher -->
      <div class="mq-column mq-column-right">
        <div class="mq-panel">
          <div class="mq-panel-title">Session Stats</div>
          <div class="mq-stat-row">
            <div class="mq-stat-pill">XP <span class="mq-stat-value" id="mq-xp">0</span></div>
            <div class="mq-stat-pill">Coins <span class="mq-stat-value" id="mq-coins">0</span></div>
            <div class="mq-stat-pill">Streak <span class="mq-stat-value" id="mq-streak">0</span></div>
            <div class="mq-stat-pill">Played <span class="mq-stat-value" id="mq-played">0</span></div>
          </div>
        </div>

        <div class="mq-panel" style="margin-top: 10px;">
          <div class="mq-panel-title">Badges</div>
          <div class="mq-panel-sub">Earn badges for streaks, XP milestones, and working your Fix-It Queue.</div>
          <div class="mq-badges-row" id="mq-badges"></div>
        </div>

        <div class="mq-panel" style="margin-top: 10px;">
          <div class="mq-panel-title">Scoreboard</div>
          <div class="mq-panel-sub">Local players on this device, sorted by XP.</div>
          <div id="mq-scoreboard" style="font-size: 11px; color: #9ca3af; line-height: 1.4;">No players yet.</div>
          <div class="mq-footer-note">This scoreboard never leaves this browser. It is not shared online.</div>
        </div>

        <div class="mq-panel" style="margin-top: 10px;">
          <div class="mq-panel-title">Teacher / Parent Notes</div>
          <div class="mq-panel-sub">Quick guidance for using BeTheMath at school or at home.</div>
          <div style="font-size: 11px; color: #9ca3af; line-height: 1.4;">
            <ul style="padding-left: 18px; margin: 0;">
              <li>Start with <strong>6‚Äì8</strong>, then adjust grade band as needed.</li>
              <li><strong>Operations</strong> fixes procedural errors. <strong>Reasoning</strong> fixes concept mistakes. <strong>Logic &amp; Patterns</strong> builds structured thinking.</li>
              <li>When a learner misses an item, read the hint, then ask: ‚ÄúWhat was the first wrong idea?‚Äù</li>
              <li>Use ‚ÄúInsights‚Äù as a 60-second review at the end.</li>
              <li>Privacy note: the app stores progress only on the current device.</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Phaser 3 (loaded but not required yet for animations) -->
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.80.0/dist/phaser.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // ----- Content library -----
      var ITEMS = [
        // -------------------------
        // K‚Äì2 ‚Äî Operations
        // -------------------------
        {
          id: "k2-op-1",
          gradeBand: "K-2",
          track: "operations",
          difficulty: "easy",
          errorType: "digit-append",
          inattention: false,
          prompt: "A student writes 7 + 5 = 75. What went wrong?",
          work: "Student work:\n7 + 5 = 75",
          options: [
            "They wrote the digits side by side instead of actually adding 7 and 5.",
            "They subtracted 5 from 7 instead of adding.",
            "They multiplied 7 √ó 5 instead of adding.",
            "They changed the 5 into 50 before adding."
          ],
          correctIndex: 0,
          hint: "What is 7 + 5 really equal to?",
          insight: "They treated addition like ‚Äústicking digits together.‚Äù Correct: 7 + 5 = 12, not 75."
        },
        {
          id: "k2-op-2",
          gradeBand: "K-2",
          track: "operations",
          difficulty: "easy",
          errorType: "extra-zero",
          inattention: true,
          prompt: "A student solves 10 ‚àí 7 = 3, but writes 30 as the answer.",
          work: "Student work:\n10 ‚àí 7 = 30",
          options: [
            "They added an extra zero out of habit, making the answer ten times too big.",
            "They subtracted 7 from the wrong number.",
            "They thought 3 and 30 mean the same amount.",
            "They added 7 instead of subtracting it."
          ],
          correctIndex: 0,
          hint: "Is 30 close to 10 or much bigger than 10?",
          insight: "They did 10 ‚àí 7 correctly (=3) but tacked on a zero. Adding a zero makes the answer 10√ó too large."
        },

        // K‚Äì2 ‚Äî Reasoning
        {
          id: "k2-re-1",
          gradeBand: "K-2",
          track: "reasoning",
          difficulty: "easy",
          errorType: "place-value-language",
          inattention: false,
          prompt: "A student says 15 is 'one ten and five ones', then writes 105.",
          work: "Student work:\n15 = 105",
          options: [
            "They tried to show tens and ones by writing all three digits, instead of using 15.",
            "They subtracted 10 from 105.",
            "They thought 15 has one hundred and five ones.",
            "They meant 10 + 5 but forgot how to write it."
          ],
          correctIndex: 0,
          hint: "How do we normally write one ten and five ones?",
          insight: "15 already means 1 ten and 5 ones. 105 is a different number (one hundred five)."
        },

        // K‚Äì2 ‚Äî Logic & Patterns
        {
          id: "k2-lo-1",
          gradeBand: "K-2",
          track: "logic",
          difficulty: "easy",
          errorType: "pattern-repeat",
          inattention: false,
          prompt: "A student sees the pattern: üîµ üî¥ üîµ üî¥ üîµ __ and fills in üîµ. What‚Äôs the better answer?",
          work: "Pattern:\nüîµ üî¥ üîµ üî¥ üîµ __\nStudent fills: üîµ",
          options: [
            "üî¥ (the colors alternate: blue, red, blue, red‚Ä¶)",
            "üîµ (because blue appears more often)",
            "Either one is correct",
            "None of the above"
          ],
          correctIndex: 0,
          hint: "Look for a repeating rule, not the most common color.",
          insight: "The pattern alternates, so after üîµ comes üî¥."
        },

        // -------------------------
        // 3‚Äì5 ‚Äî Operations
        // -------------------------
        {
          id: "35-op-1",
          gradeBand: "3-5",
          track: "operations",
          difficulty: "medium",
          errorType: "carry-borrow",
          inattention: false,
          prompt: "A student solves 27 + 38 and writes 55.",
          work: "Student work:\n27 + 38 = 55",
          options: [
            "They added only the tens and forgot to add and carry from the ones place.",
            "They subtracted 27 from 38 instead of adding.",
            "They multiplied the digits in each number.",
            "They rounded both numbers first and never went back."
          ],
          correctIndex: 0,
          hint: "Add the ones (7 + 8) first. What happens to the 1 in 15?",
          insight: "Correct: 7+8=15 (write 5 carry 1), then 2+3+1=6 ‚Üí 65."
        },

        // 3‚Äì5 ‚Äî Reasoning
        {
          id: "35-re-1",
          gradeBand: "3-5",
          track: "reasoning",
          difficulty: "medium",
          errorType: "percent-decimal",
          inattention: false,
          prompt: "A student says 0.5 is the same as 5%.",
          work: "Student idea:\n0.5 = 5%",
          options: [
            "They forgot that 0.5 means 50%, not 5%.",
            "They added 50 instead of 5.",
            "They turned 5% into 0.05 and got confused.",
            "They mixed up numerator and denominator."
          ],
          correctIndex: 0,
          hint: "One-half of something is closer to 5% or 50%?",
          insight: "0.5 is 1/2 = 50%. Five percent is 0.05 (much smaller)."
        },

        // 3‚Äì5 ‚Äî Logic & Patterns
        {
          id: "35-lo-1",
          gradeBand: "3-5",
          track: "logic",
          difficulty: "medium",
          errorType: "rule-application",
          inattention: false,
          prompt: "A student sees: 2 ‚Üí 5, 3 ‚Üí 7, 4 ‚Üí 9, and says the rule is 'add 2'. What‚Äôs wrong?",
          work: "Pairs:\n2‚Üí5\n3‚Üí7\n4‚Üí9\nStudent rule: add 2",
          options: [
            "The rule changes each time; it‚Äôs actually 'multiply by 2, then add 1'.",
            "The rule is 'add 3' every time.",
            "There is no rule.",
            "The rule is 'subtract 1'."
          ],
          correctIndex: 0,
          hint: "Try the same rule on every input. Does it work for all three?",
          insight: "2√ó2+1=5, 3√ó2+1=7, 4√ó2+1=9. One rule should fit every pair."
        },

        // -------------------------
        // 6‚Äì8 ‚Äî Operations
        // -------------------------
        {
          id: "68-op-1",
          gradeBand: "6-8",
          track: "operations",
          difficulty: "medium",
          errorType: "fraction-addition",
          inattention: false,
          prompt: "A student adds fractions and gets 1/4 + 1/2 = 2/6.",
          work: "Student work:\n1/4 + 1/2 = 2/6",
          options: [
            "They added numerators and denominators straight across instead of using a common denominator.",
            "They multiplied the fractions instead of adding.",
            "They subtracted one fraction from the other.",
            "They tried to simplify 3/4 but used the wrong numbers."
          ],
          correctIndex: 0,
          hint: "What common denominator works for 4 and 2?",
          insight: "Use a common denominator: 1/4 + 1/2 = 1/4 + 2/4 = 3/4."
        },
        {
          id: "68-op-2",
          gradeBand: "6-8",
          track: "operations",
          difficulty: "medium",
          errorType: "integer-sign",
          inattention: true,
          prompt: "A student computes ‚àí8 + 5 and writes ‚àí13.",
          work: "Student work:\n‚àí8 + 5 = ‚àí13",
          options: [
            "They added the numbers as if both were negative, instead of combining a negative and a positive.",
            "They subtracted 5 from 8 but forgot the sign.",
            "They multiplied ‚àí8 by 5 instead of adding.",
            "They changed ‚àí8 into +8 by mistake."
          ],
          correctIndex: 0,
          hint: "Which is bigger in absolute value: 8 or 5?",
          insight: "The negative is stronger by 3, so ‚àí8 + 5 = ‚àí3."
        },
        {
          id: "68-op-3",
          gradeBand: "6-8",
          track: "operations",
          difficulty: "medium",
          errorType: "distribution",
          inattention: false,
          prompt: "A student simplifies 5(2x + 1) and writes 10x + 1.",
          work: "Student work:\n5(2x + 1) = 10x + 1",
          options: [
            "They multiplied the variable term but forgot to multiply the constant by 5.",
            "They multiplied everything by 10 instead of 5.",
            "They added 5 to 2x and left +1 alone.",
            "They distributed 5 only to the 1."
          ],
          correctIndex: 0,
          hint: "How many terms are inside the parentheses?",
          insight: "Distribute to every term: 5(2x+1)=10x+5."
        },

        // 6‚Äì8 ‚Äî Reasoning
        {
          id: "68-re-1",
          gradeBand: "6-8",
          track: "reasoning",
          difficulty: "medium",
          errorType: "square-negative",
          inattention: false,
          prompt: "A student says (‚àí3)¬≤ = ‚àí9 because 'the answer stays negative'.",
          work: "Student work:\n(‚àí3)¬≤ = ‚àí9",
          options: [
            "They forgot that squaring means multiply by itself, and a negative times a negative is positive.",
            "They multiplied 3 √ó 2 instead of squaring.",
            "They changed the sign twice in the wrong places.",
            "They squared only the negative sign."
          ],
          correctIndex: 0,
          hint: "Rewrite (‚àí3)¬≤ as (‚àí3)√ó(‚àí3).",
          insight: "(‚àí3)√ó(‚àí3)=+9, so (‚àí3)¬≤ = 9."
        },

        // 6‚Äì8 ‚Äî Logic & Patterns
        {
          id: "68-lo-1",
          gradeBand: "6-8",
          track: "logic",
          difficulty: "medium",
          errorType: "sequence-step",
          inattention: false,
          prompt: "A student says the sequence 3, 7, 15, 31 grows by +4, +8, +16 so the next is 47. What‚Äôs the better next term?",
          work: "Sequence:\n3, 7, 15, 31, __\nStudent answer: 47",
          options: [
            "63 (because the differences double: +4, +8, +16, +32)",
            "47 (because +16 repeats)",
            "49 (because 7√ó7)",
            "60 (because add 29)"
          ],
          correctIndex: 0,
          hint: "Continue the pattern in the differences.",
          insight: "Differences double: 31 + 32 = 63."
        },

        // -------------------------
        // Algebra I ‚Äî Operations
        // -------------------------
        {
          id: "alg1-op-1",
          gradeBand: "Alg1",
          track: "operations",
          difficulty: "medium",
          errorType: "distribution",
          inattention: false,
          prompt: "A student expands 2(x + 3) as 2x + 3.",
          work: "Student work:\n2(x + 3) = 2x + 3",
          options: [
            "They distributed 2 to x but forgot to multiply 3 by 2.",
            "They added 2 to x and then added 3.",
            "They subtracted 3 instead of adding.",
            "They divided everything by 2 first."
          ],
          correctIndex: 0,
          hint: "What should 2 multiply inside the parentheses?",
          insight: "2(x+3)=2x+6."
        },

        // Algebra I ‚Äî Reasoning
        {
          id: "alg1-re-1",
          gradeBand: "Alg1",
          track: "reasoning",
          difficulty: "hard",
          errorType: "equivalent-forms",
          inattention: false,
          prompt: "A student says y = 4x + 1 and 4x ‚àí y = ‚àí1 are different lines.",
          work: "Student claim:\n‚ÄúDifferent lines‚Äù",
          options: [
            "They didn‚Äôt recognize that rearranging an equation can give an equivalent form of the same line.",
            "They thought subtracting y always changes slope.",
            "They confused x-intercept with y-intercept.",
            "They assumed any minus sign makes a new line."
          ],
          correctIndex: 0,
          hint: "Solve 4x ‚àí y = ‚àí1 for y.",
          insight: "Rearrange: 4x ‚àí y = ‚àí1 ‚Üí ‚àíy = ‚àí4x ‚àí 1 ‚Üí y = 4x + 1. Same line."
        },

        // Algebra I ‚Äî Logic & Patterns
        {
          id: "alg1-lo-1",
          gradeBand: "Alg1",
          track: "logic",
          difficulty: "medium",
          errorType: "if-then",
          inattention: false,
          prompt: "A student says: ‚ÄúIf a number is divisible by 4, then it must be even. So if it's even, it must be divisible by 4.‚Äù What‚Äôs wrong?",
          work: "Student reasoning:\nDivisible by 4 ‚Üí Even\nEven ‚Üí Divisible by 4",
          options: [
            "They reversed the implication. Even numbers don‚Äôt have to be divisible by 4.",
            "Divisible by 4 numbers are not even.",
            "Even numbers are never divisible by 4.",
            "The statement is correct."
          ],
          correctIndex: 0,
          hint: "Find a counterexample: an even number not divisible by 4.",
          insight: "Example: 6 is even but not divisible by 4. The reverse statement is false."
        },

        // -------------------------
        // Geometry ‚Äî Operations
        // -------------------------
        {
          id: "geo-op-1",
          gradeBand: "Geo",
          track: "operations",
          difficulty: "medium",
          errorType: "perimeter-area",
          inattention: false,
          prompt: "A student finds the perimeter of a rectangle with sides 3 and 5 by computing 3 √ó 5 = 15.",
          work: "Student work:\nPerimeter = 15",
          options: [
            "They used the area formula (length √ó width) instead of adding all side lengths.",
            "They added the sides in the wrong order.",
            "They subtracted 3 from 5 instead.",
            "They halved the side lengths first."
          ],
          correctIndex: 0,
          hint: "Perimeter means walk around the shape.",
          insight: "Perimeter is 3+5+3+5=16, not 15."
        },

        // Geometry ‚Äî Reasoning
        {
          id: "geo-re-1",
          gradeBand: "Geo",
          track: "reasoning",
          difficulty: "medium",
          errorType: "triangle-angle-sum",
          inattention: false,
          prompt: "A student says the angles in a triangle add to 200¬∞ because ‚Äú100 + 50 + 50 = 200‚Äù.",
          work: "Student work:\nTriangle angle sum = 200¬∞",
          options: [
            "They ignored the rule that triangle angles must sum to 180¬∞.",
            "They used quadrilateral rules.",
            "They mixed up degrees and radians.",
            "They doubled one angle by mistake."
          ],
          correctIndex: 0,
          hint: "What is the angle sum of any triangle?",
          insight: "Even if 100+50+50=200, those angles cannot form a triangle because triangles must total 180¬∞."
        },

        // Geometry ‚Äî Logic & Patterns
        {
          id: "geo-lo-1",
          gradeBand: "Geo",
          track: "logic",
          difficulty: "hard",
          errorType: "proof-structure",
          inattention: true,
          prompt: "A student proof uses the conclusion as a reason in the middle of the proof. What‚Äôs the issue?",
          work: "Student proof:\nStep 4 says 'Triangles are congruent' to justify Step 5,\nbut triangle congruence is what the proof is trying to prove.",
          options: [
            "They used circular reasoning (assuming the result they need to prove).",
            "They forgot a diagram label.",
            "They used the wrong theorem name only.",
            "There is no issue."
          ],
          correctIndex: 0,
          hint: "A proof can‚Äôt assume what it‚Äôs trying to show.",
          insight: "That‚Äôs circular reasoning: the conclusion must come at the end, not be used as a reason in the middle."
        },

        // -------------------------
        // Algebra II ‚Äî Operations
        // -------------------------
        {
          id: "alg2-op-1",
          gradeBand: "Alg2",
          track: "operations",
          difficulty: "medium",
          errorType: "expansion",
          inattention: false,
          prompt: "A student expands (x + 2)¬≤ and writes x¬≤ + 4.",
          work: "Student work:\n(x + 2)¬≤ = x¬≤ + 4",
          options: [
            "They forgot the middle term 2¬∑x¬∑2 = 4x.",
            "They multiplied x by 2 then squared.",
            "They added 2 to x¬≤ instead of squaring.",
            "They confused (x+2)¬≤ with (x¬≤+2)¬≤."
          ],
          correctIndex: 0,
          hint: "Use (a+b)¬≤ = a¬≤ + 2ab + b¬≤.",
          insight: "(x+2)¬≤ = x¬≤ + 4x + 4."
        },

        // Algebra II ‚Äî Reasoning
        {
          id: "alg2-re-1",
          gradeBand: "Alg2",
          track: "reasoning",
          difficulty: "hard",
          errorType: "factored-form",
          inattention: false,
          prompt: "A student simplifies (x ‚àí 3)(x + 3) and writes x¬≤ + 9.",
          work: "Student work:\n(x ‚àí 3)(x + 3) = x¬≤ + 9",
          options: [
            "They missed the difference of squares pattern: (a‚àíb)(a+b)=a¬≤‚àíb¬≤.",
            "They added the binomials first, then squared.",
            "They multiplied only the x terms.",
            "They thought 3x and ‚àí3x add to 6x."
          ],
          correctIndex: 0,
          hint: "What is (a‚àíb)(a+b) equal to?",
          insight: "(x‚àí3)(x+3)=x¬≤‚àí9, not x¬≤+9."
        },

        // Algebra II ‚Äî Logic & Patterns
        {
          id: "alg2-lo-1",
          gradeBand: "Alg2",
          track: "logic",
          difficulty: "hard",
          errorType: "counterexample",
          inattention: false,
          prompt: "A student claims: ‚ÄúIf x¬≤ = 9, then x = 3.‚Äù What‚Äôs missing?",
          work: "Student work:\nx¬≤ = 9 ‚Üí x = 3",
          options: [
            "They forgot the second solution: x can be ‚àí3 as well.",
            "x cannot be 3.",
            "9 has no square roots.",
            "They should divide by 2."
          ],
          correctIndex: 0,
          hint: "What numbers squared give 9?",
          insight: "Both 3 and ‚àí3 square to 9, so x = ¬±3."
        },

        // -------------------------
        // Trigonometry ‚Äî Operations
        // -------------------------
        {
          id: "trig-op-1",
          gradeBand: "Trig",
          track: "operations",
          difficulty: "medium",
          errorType: "sohcahtoa",
          inattention: false,
          prompt: "A student writes sin(Œ∏) = adjacent/hypotenuse. What went wrong?",
          work: "Student work:\nsin(Œ∏) = adjacent / hypotenuse",
          options: [
            "They swapped sine and cosine. sin(Œ∏)=opposite/hypotenuse.",
            "They swapped sine and tangent. sin(Œ∏)=opposite/adjacent.",
            "They should use degrees, not a ratio.",
            "Sine has no relation to triangles."
          ],
          correctIndex: 0,
          hint: "SOH: Sine = Opposite over Hypotenuse.",
          insight: "Sine uses opposite/hypotenuse; adjacent/hypotenuse is cosine."
        },

        // Trigonometry ‚Äî Reasoning
        {
          id: "trig-re-1",
          gradeBand: "Trig",
          track: "reasoning",
          difficulty: "hard",
          errorType: "unit-circle-angle",
          inattention: true,
          prompt: "A student evaluates sin(œÄ) and writes 1 because ‚ÄúœÄ is 180¬∞, the top of the circle.‚Äù",
          work: "Student work:\nsin(œÄ) = 1",
          options: [
            "They confused sin(œÄ/2)=1 with sin(œÄ)=0. At œÄ the point is (‚àí1,0).",
            "They used cosine instead of sine.",
            "They mixed radians and degrees so nothing works.",
            "They thought sine is always 1 at important angles."
          ],
          correctIndex: 0,
          hint: "On the unit circle, what are the coordinates at œÄ?",
          insight: "At œÄ (180¬∞), the point is (‚àí1,0). Sine is the y-coordinate, so sin(œÄ)=0."
        },

        // Trigonometry ‚Äî Logic & Patterns
        {
          id: "trig-lo-1",
          gradeBand: "Trig",
          track: "logic",
          difficulty: "medium",
          errorType: "periodicity",
          inattention: false,
          prompt: "A student says sin(Œ∏) = sin(Œ∏ + œÄ). What‚Äôs the issue?",
          work: "Student claim:\nsin(Œ∏) = sin(Œ∏ + œÄ)",
          options: [
            "Sine‚Äôs period is 2œÄ, not œÄ. sin(Œ∏+2œÄ)=sin(Œ∏), but sin(Œ∏+œÄ)=‚àísin(Œ∏).",
            "Sine has period œÄ.",
            "Sine has no period.",
            "The statement is always true."
          ],
          correctIndex: 0,
          hint: "Try Œ∏=œÄ/2. Compare sin(œÄ/2) and sin(œÄ/2+œÄ).",
          insight: "sin(œÄ/2)=1, sin(3œÄ/2)=‚àí1. So adding œÄ flips the sign."
        },

        // -------------------------
        // Pre-Calculus ‚Äî Operations
        // -------------------------
        {
          id: "precalc-op-1",
          gradeBand: "PreCalc",
          track: "operations",
          difficulty: "hard",
          errorType: "function-shift",
          inattention: false,
          prompt: "A student says f(x)= (x‚àí3)¬≤ shifts the graph of x¬≤ left by 3.",
          work: "Student claim:\n(x‚àí3)¬≤ shifts left 3",
          options: [
            "They reversed the horizontal shift. (x‚àí3) shifts right 3.",
            "It shifts up 3.",
            "It shifts down 3.",
            "It reflects across the y-axis."
          ],
          correctIndex: 0,
          hint: "Inside the parentheses, the shift is opposite the sign.",
          insight: "(x‚àí3)¬≤ moves the parabola right 3."
        },

        // Pre-Calculus ‚Äî Reasoning
        {
          id: "precalc-re-1",
          gradeBand: "PreCalc",
          track: "reasoning",
          difficulty: "hard",
          errorType: "domain-misread",
          inattention: true,
          prompt: "A student says the domain of ‚àö(x‚àí5) is all real numbers.",
          work: "Student statement:\nDomain is all real numbers",
          options: [
            "They forgot the radicand must be ‚â• 0, so x‚àí5 ‚â• 0 ‚Üí x ‚â• 5.",
            "They confused domain with range.",
            "Square roots only accept negative inputs.",
            "Domains are never restricted."
          ],
          correctIndex: 0,
          hint: "What must be true inside the square root?",
          insight: "Require x‚àí5 ‚â• 0, so x ‚â• 5."
        },

        // Pre-Calculus ‚Äî Logic & Patterns
        {
          id: "precalc-lo-1",
          gradeBand: "PreCalc",
          track: "logic",
          difficulty: "medium",
          errorType: "quantifiers",
          inattention: false,
          prompt: "A student says: ‚ÄúBecause f(2)=0, the function must have a root at every x.‚Äù What‚Äôs the flaw?",
          work: "Student reasoning:\nOne example ‚Üí always true",
          options: [
            "They overgeneralized from one example. One root doesn‚Äôt mean every x is a root.",
            "If f(2)=0 then f is undefined.",
            "Roots only exist for linear functions.",
            "The statement is correct."
          ],
          correctIndex: 0,
          hint: "Does one case prove all cases?",
          insight: "A single example shows existence, not ‚Äúfor all.‚Äù"
        },

        // -------------------------
        // Calculus ‚Äî Operations
        // -------------------------
        {
          id: "calc-op-1",
          gradeBand: "Calc",
          track: "operations",
          difficulty: "hard",
          errorType: "derivative-rule",
          inattention: false,
          prompt: "A student says the derivative of f(x)=x¬≤ is f‚Ä≤(x)=2x¬≤.",
          work: "Student work:\nd/dx (x¬≤) = 2x¬≤",
          options: [
            "They multiplied by the exponent but forgot to reduce the power by 1.",
            "They differentiated twice.",
            "They integrated instead of differentiating.",
            "They changed x¬≤ into 2x before differentiating."
          ],
          correctIndex: 0,
          hint: "Power rule: d/dx(x‚Åø)=n¬∑x^(n‚àí1).",
          insight: "Correct derivative: 2x^(2‚àí1)=2x."
        },

        // Calculus ‚Äî Reasoning
        {
          id: "calc-re-1",
          gradeBand: "Calc",
          track: "reasoning",
          difficulty: "hard",
          errorType: "slope-meaning",
          inattention: true,
          prompt: "A student says f‚Ä≤(a) is the y-value of the function at x=a.",
          work: "Student statement:\nf‚Ä≤(a) = f(a)",
          options: [
            "They confused derivative with function value. f‚Ä≤(a) is slope of the tangent at x=a.",
            "They confused slope with area.",
            "They confused intercept with slope only.",
            "They are correct."
          ],
          correctIndex: 0,
          hint: "Derivative answers ‚Äúhow fast is it changing?‚Äù",
          insight: "f(a) is the height; f‚Ä≤(a) is the instantaneous rate of change (slope)."
        },

        // Calculus ‚Äî Logic & Patterns
        {
          id: "calc-lo-1",
          gradeBand: "Calc",
          track: "logic",
          difficulty: "medium",
          errorType: "limit-language",
          inattention: false,
          prompt: "A student says: ‚ÄúIf lim(x‚Üía) f(x) exists, then f(a) must be defined.‚Äù What‚Äôs wrong?",
          work: "Student claim:\nLimit exists ‚Üí f(a) defined",
          options: [
            "A limit can exist even if f(a) is undefined or different (a removable discontinuity).",
            "If a limit exists, the function must be a polynomial.",
            "Limits only exist when f(a)=0.",
            "The statement is always true."
          ],
          correctIndex: 0,
          hint: "Think about a ‚Äúhole‚Äù in the graph at x=a.",
          insight: "A limit describes nearby behavior. f(a) may be undefined or set to a different value."
        }
      ];

      // ----- State -----
      function makeEmptyState() {
        return {
          xp: 0,
          coins: 0,
          streak: 0,
          played: 0,
          gradeBand: "6-8",       // ‚úÖ default start at 6‚Äì8
          track: "operations",
          missed: [],
          errorWeakness: {}
        };
      }

      function isInattentionItem(item) {
        return !!(item && item.inattention);
      }

      var state = makeEmptyState();

      // ‚úÖ New storage key so the app starts clean at 6‚Äì8 (no old saved grade band overriding)
      var STORAGE_KEY = "bethemath_players_v1";

      var players = {};
      var activePlayerId = null;
      var lastItemId = null;

      function $(id) { return document.getElementById(id); }

      var els = {
        grade: $("mq-grade"),
        track: $("mq-track"),
        question: $("mq-question"),
        work: $("mq-work"),
        options: $("mq-options"),
        feedback: $("mq-feedback"),
        queueNote: $("mq-queue-note"),
        xp: $("mq-xp"),
        coins: $("mq-coins"),
        streak: $("mq-streak"),
        played: $("mq-played"),
        badges: $("mq-badges"),
        autosave: $("mq-autosave"),
        highContrast: $("mq-high-contrast"),
        dyslexic: $("mq-dyslexic"),
        reset: $("mq-reset"),
        insightLog: $("mq-insight-log"),
        scoreboard: $("mq-scoreboard")
      };

      var scaleSlider = $("mq-scale");
      var delaySlider = $("mq-delay");
      var sfxButton = $("mq-sfx-toggle");
      var nextButton = $("mq-next");
      var sfxOn = true;
      var audioCtx = null;
      var nextTimer = null;
      var autoAdvanceDelayMs = 5000;

      function loadPlayers() {
        players = {};
        activePlayerId = null;

        try {
          var raw = localStorage.getItem(STORAGE_KEY);
          if (raw) {
            var parsed = JSON.parse(raw);
            if (parsed && typeof parsed === "object" && parsed.players) {
              players = parsed.players;
              activePlayerId = parsed.activeId || null;
            }
          }
        } catch (e) {
          players = {};
          activePlayerId = null;
        }

        if (!players || Object.keys(players).length === 0) {
          var id = "p1";
          players = {};
          players[id] = { name: "Player 1", state: makeEmptyState() };
          activePlayerId = id;
        }

        var active = players[activePlayerId];
        if (active && active.state) {
          state = Object.assign(makeEmptyState(), active.state);
          if (!state.errorWeakness) state.errorWeakness = {};
        } else {
          state = makeEmptyState();
        }
      }

      function savePlayers() {
        if (!activePlayerId || !players[activePlayerId]) return;
        players[activePlayerId].state = state;

        try {
          localStorage.setItem(
            STORAGE_KEY,
            JSON.stringify({ activeId: activePlayerId, players: players })
          );
          if (els.autosave && players[activePlayerId]) {
            els.autosave.textContent = "Progress saved for " + players[activePlayerId].name + ".";
          }
        } catch (e) {
          if (els.autosave) els.autosave.textContent = "Autosave skipped (storage unavailable).";
        }
      }

      function refreshPlayerSelect() {
        var select = $("mq-player");
        if (!select) return;
        select.innerHTML = "";

        Object.keys(players).forEach(function (id) {
          var opt = document.createElement("option");
          opt.value = id;
          opt.textContent = players[id].name || id;
          if (id === activePlayerId) opt.selected = true;
          select.appendChild(opt);
        });
      }

      function syncSelectorsFromState() {
        if (els.grade) els.grade.value = state.gradeBand;
        if (els.track) els.track.value = state.track;
      }

      function updateScoreboard() {
        if (!els.scoreboard) return;

        var ids = Object.keys(players);
        if (ids.length === 0) {
          els.scoreboard.textContent = "No players yet.";
          return;
        }

        var summary = ids.map(function (id) {
          var p = players[id];
          var st = p.state || makeEmptyState();
          return { name: p.name || id, xp: st.xp || 0, coins: st.coins || 0 };
        });

        summary.sort(function (a, b) {
          if (b.xp !== a.xp) return b.xp - a.xp;
          if (b.coins !== a.coins) return b.coins - a.coins;
          return a.name.localeCompare(b.name);
        });

        var html = "<ol style='padding-left: 18px; margin: 0;'>";
        summary.forEach(function (p) {
          html += "<li>" + p.name + " ‚Äî XP " + p.xp + ", Coins " + p.coins + "</li>";
        });
        html += "</ol>";

        els.scoreboard.innerHTML = html;
      }

      function updateStats() {
        if (els.xp) els.xp.textContent = state.xp;
        if (els.coins) els.coins.textContent = state.coins;
        if (els.streak) els.streak.textContent = state.streak;
        if (els.played) els.played.textContent = state.played;
        savePlayers();
        updateScoreboard();
      }

      function updateBadges() {
        if (!els.badges) return;
        els.badges.innerHTML = "";
        var list = [];

        if (state.played >= 1) list.push("First Fix");
        if (state.streak >= 3) list.push("Streak 3+");
        if (state.streak >= 5) list.push("Streak 5+");
        if (state.xp >= 20) list.push("20+ XP");
        if (state.xp >= 50) list.push("50+ XP");
        if (state.missed && state.missed.length >= 3) list.push("Fix-It Queue");

        list.forEach(function (label) {
          var chip = document.createElement("div");
          chip.className = "mq-badge-chip mq-badge-earned";
          chip.textContent = "‚òÖ " + label;
          els.badges.appendChild(chip);
        });
      }

      function getPool() {
        return ITEMS.filter(function (item) {
          return item.gradeBand === state.gradeBand && item.track === state.track;
        });
      }

      function getTopWeakErrorTypes() {
        var map = state.errorWeakness || {};
        var types = Object.keys(map);
        if (types.length === 0) return [];
        var entries = types.map(function (t) { return { type: t, score: map[t] }; });
        entries.sort(function (a, b) { return b.score - a.score; });
        var filtered = entries.filter(function (e) { return e.score >= 2; });
        if (filtered.length === 0) return [];
        return filtered.map(function (e) { return e.type; });
      }

      function pickDifficultyFromPool(pool) {
        if (!pool || pool.length === 0) return null;

        var present = { easy: false, medium: false, hard: false };
        pool.forEach(function (item) {
          if (item.difficulty && present.hasOwnProperty(item.difficulty)) present[item.difficulty] = true;
        });

        var streak = state.streak || 0;
        var weights = { easy: 0, medium: 0, hard: 0 };

        if (streak <= 1) {
          weights.easy = 0.7; weights.medium = 0.25; weights.hard = 0.05;
        } else if (streak <= 4) {
          weights.easy = 0.4; weights.medium = 0.4; weights.hard = 0.2;
        } else {
          weights.easy = 0.2; weights.medium = 0.4; weights.hard = 0.4;
        }

        var available = [];
        ["easy", "medium", "hard"].forEach(function (d) {
          if (present[d] && weights[d] > 0) available.push({ difficulty: d, weight: weights[d] });
        });

        if (available.length === 0) {
          var fallback = [];
          pool.forEach(function (item) {
            if (item.difficulty && present.hasOwnProperty(item.difficulty)) {
              if (fallback.indexOf(item.difficulty) === -1) fallback.push(item.difficulty);
            }
          });
          if (fallback.length === 0) return null;
          return fallback[Math.floor(Math.random() * fallback.length)];
        }

        var total = available.reduce(function (sum, d) { return sum + d.weight; }, 0);
        var r = Math.random() * total;
        var acc = 0;
        for (var i = 0; i < available.length; i++) {
          acc += available[i].weight;
          if (r <= acc) return available[i].difficulty;
        }
        return available[available.length - 1].difficulty;
      }

      function chooseAdaptiveFromPool(pool) {
        if (!pool || pool.length === 0) return null;

        var difficulty = pickDifficultyFromPool(pool);
        var candidates = pool;

        if (difficulty) {
          var filtered = pool.filter(function (item) { return item.difficulty === difficulty; });
          if (filtered.length > 0) candidates = filtered;
        }

        var weakTypes = getTopWeakErrorTypes();
        if (weakTypes.length > 0 && Math.random() < 0.5) {
          var focusType = weakTypes[0];
          var typeFiltered = candidates.filter(function (item) { return item.errorType === focusType; });
          if (typeFiltered.length > 0) candidates = typeFiltered;
        }

        if (candidates.length > 1 && lastItemId) {
          var diffCandidates = candidates.filter(function (item) { return item.id !== lastItemId; });
          if (diffCandidates.length > 0) candidates = diffCandidates;
        }

        var idx = Math.floor(Math.random() * candidates.length);
        return candidates[idx];
      }

      function getNextItem() {
        var fromMissed = false;
        var item = null;

        if (state.missed && state.missed.length > 0 && Math.random() < 0.4) {
          var idx = Math.floor(Math.random() * state.missed.length);
          item = state.missed[idx];
          fromMissed = true;
          state.missed.splice(idx, 1);
        } else {
          var pool = getPool();
          if (pool.length === 0) return { item: null, fromMissed: false };
          item = chooseAdaptiveFromPool(pool) || pool[Math.floor(Math.random() * pool.length)];
        }

        return { item: item, fromMissed: fromMissed };
      }

      var currentItem = null;

      function appendInsightLog(item, correct) {
        if (!els.insightLog || !item) return;
        var div = document.createElement("div");
        div.style.marginBottom = "6px";
        var label = correct ? "‚úîÔ∏è Insight" : "üîÅ Fix-It insight";
        div.innerHTML = "<strong>" + label + ":</strong> " + item.insight;
        els.insightLog.prepend(div);
      }

      function renderItem(next) {
        currentItem = next.item;

        if (nextTimer) { clearTimeout(nextTimer); nextTimer = null; }
        if (nextButton) nextButton.disabled = false;

        if (!currentItem) {
          if (els.question) els.question.textContent = "No items for this grade band and track yet.";
          if (els.work) els.work.textContent = "";
          if (els.options) els.options.innerHTML = "";
          if (els.feedback) {
            els.feedback.textContent = "Try another grade band or track.";
            els.feedback.className = "mq-feedback";
          }
          if (els.queueNote) els.queueNote.textContent = "";
          return;
        }

        lastItemId = currentItem.id;

        if (els.question) els.question.textContent = currentItem.prompt;
        if (els.work) els.work.textContent = currentItem.work || "";
        if (els.feedback) {
          els.feedback.textContent = "Pick the best explanation or fix for this student's work.";
          els.feedback.className = "mq-feedback";
        }

        if (els.queueNote) {
          var inattentionLabel = "";
          if (isInattentionItem(currentItem)) inattentionLabel = " <span style='color:#facc15;'>‚ö† Inattention focus</span>";

          if (next.fromMissed) {
            els.queueNote.innerHTML = "üîÅ <strong>Fix-It Queue:</strong> back for another try." + inattentionLabel;
          } else {
            els.queueNote.innerHTML = "‚ú® New error from this grade band and track." + inattentionLabel;
          }
        }

        if (!els.options) return;
        els.options.innerHTML = "";

        currentItem.options.forEach(function (optText, index) {
          var btn = document.createElement("button");
          btn.type = "button";
          btn.className = "mq-option-btn";
          btn.textContent = optText;
          btn.addEventListener("click", function () { handleAnswer(index); });
          els.options.appendChild(btn);
        });
      }

      function playBeep(correct) {
        if (!sfxOn) return;
        try {
          if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          var oscillator = audioCtx.createOscillator();
          var gain = audioCtx.createGain();
          oscillator.connect(gain);
          gain.connect(audioCtx.destination);

          oscillator.type = "square";
          oscillator.frequency.value = correct ? 1200 : 400;

          var now = audioCtx.currentTime;
          gain.gain.setValueAtTime(0.0001, now);
          gain.gain.exponentialRampToValueAtTime(0.45, now + 0.02);
          gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.3);

          oscillator.start(now);
          oscillator.stop(now + 0.32);
        } catch (e) {}
      }

      function scheduleNextItem() {
        if (nextTimer) { clearTimeout(nextTimer); nextTimer = null; }
        nextTimer = setTimeout(function () {
          var next = getNextItem();
          renderItem(next);
        }, autoAdvanceDelayMs);
      }

      function handleAnswer(selectedIndex) {
        if (!currentItem) return;

        var buttons = els.options
          ? Array.prototype.slice.call(els.options.querySelectorAll(".mq-option-btn"))
          : [];

        var correct = selectedIndex === currentItem.correctIndex;

        buttons.forEach(function (btn, index) {
          btn.disabled = true;
          btn.classList.remove("mq-correct", "mq-incorrect");
          if (index === currentItem.correctIndex) btn.classList.add("mq-correct");
          if (!correct && index === selectedIndex) btn.classList.add("mq-incorrect");
        });

        playBeep(correct);
        state.played += 1;

        if (!state.errorWeakness) state.errorWeakness = {};
        if (!correct && currentItem.errorType) {
          if (!state.errorWeakness[currentItem.errorType]) state.errorWeakness[currentItem.errorType] = 0;
          state.errorWeakness[currentItem.errorType] += 1;
        }

        if (correct) {
          state.xp += 5;
          state.coins += 1;
          state.streak += 1;
          if (els.feedback) {
            els.feedback.textContent = "Nice fix! " + currentItem.insight;
            els.feedback.className = "mq-feedback mq-feedback-correct";
          }
          appendInsightLog(currentItem, true);
        } else {
          state.streak = 0;
          state.missed.push(currentItem);
          if (els.feedback) {
            els.feedback.textContent = "Good attempt. Hint: " + currentItem.hint;
            els.feedback.className = "mq-feedback mq-feedback-encouraging";
          }
          appendInsightLog(currentItem, false);
        }

        updateStats();
        updateBadges();
        scheduleNextItem();
      }

      function applyVisualToggles() {
        var body = document.body;
        if (els.highContrast) {
          if (els.highContrast.checked) body.classList.add("mq-high-contrast");
          else body.classList.remove("mq-high-contrast");
        }
        if (els.dyslexic) {
          if (els.dyslexic.checked) body.classList.add("mq-dyslexic");
          else body.classList.remove("mq-dyslexic");
        }
      }

      if (els.grade) {
        els.grade.addEventListener("change", function (e) {
          state.gradeBand = e.target.value;
          updateStats();
          renderItem(getNextItem());
        });
      }

      if (els.track) {
        els.track.addEventListener("change", function (e) {
          state.track = e.target.value;
          updateStats();
          renderItem(getNextItem());
        });
      }

      if (els.highContrast) els.highContrast.addEventListener("change", applyVisualToggles);
      if (els.dyslexic) els.dyslexic.addEventListener("change", applyVisualToggles);

      if (els.reset) {
        els.reset.addEventListener("click", function () {
          if (!confirm("Reset XP, coins, streak, and Fix-It Queue for this player?")) return;
          state = makeEmptyState();
          state.gradeBand = els.grade ? els.grade.value : "6-8";
          state.track = els.track ? els.track.value : "operations";
          if (els.insightLog) els.insightLog.innerHTML = "";
          updateStats();
          updateBadges();
          renderItem(getNextItem());
        });
      }

      if (scaleSlider) {
        var initialScale = scaleSlider.value ? parseInt(scaleSlider.value, 10) / 100 : 1;
        document.documentElement.style.setProperty("--mq-scale", initialScale);

        scaleSlider.addEventListener("input", function (e) {
          var value = parseInt(e.target.value, 10) || 100;
          document.documentElement.style.setProperty("--mq-scale", value / 100);
        });
      }

      if (delaySlider) {
        autoAdvanceDelayMs = (parseInt(delaySlider.value, 10) || 5) * 1000;
        delaySlider.addEventListener("input", function (e) {
          var secs = parseInt(e.target.value, 10) || 5;
          autoAdvanceDelayMs = secs * 1000;
        });
      }

      if (sfxButton) {
        sfxButton.classList.add("mq-sfx-on");
        sfxButton.addEventListener("click", function () {
          sfxOn = !sfxOn;
          sfxButton.textContent = sfxOn ? "SFX: ON" : "SFX: OFF";
          if (sfxOn) sfxButton.classList.add("mq-sfx-on");
          else sfxButton.classList.remove("mq-sfx-on");
        });
      }

      if (nextButton) {
        nextButton.addEventListener("click", function () {
          if (nextTimer) { clearTimeout(nextTimer); nextTimer = null; }
          renderItem(getNextItem());
        });
      }

      var playerSelect = $("mq-player");
      var playerAddBtn = $("mq-player-add");
      var playerDeleteBtn = $("mq-player-delete");

      if (playerSelect) {
        playerSelect.addEventListener("change", function (e) {
          var newId = e.target.value;
          if (!players[newId]) return;
          savePlayers();
          activePlayerId = newId;
          var active = players[activePlayerId];
          state = Object.assign(makeEmptyState(), active.state || {});
          if (!state.errorWeakness) state.errorWeakness = {};
          syncSelectorsFromState();
          updateStats();
          updateBadges();
          renderItem(getNextItem());
        });
      }

      if (playerAddBtn) {
        playerAddBtn.addEventListener("click", function () {
          var name = prompt("New player name:", "Player " + (Object.keys(players).length + 1));
          if (!name) return;

          var base = name;
          var counter = 2;
          var existingNames = Object.keys(players).map(function (id) { return players[id].name; });
          while (existingNames.indexOf(name) !== -1) {
            name = base + " (" + counter + ")";
            counter++;
          }

          var newId = "p" + Date.now();
          players[newId] = { name: name, state: makeEmptyState() };
          activePlayerId = newId;
          state = makeEmptyState();
          syncSelectorsFromState();
          refreshPlayerSelect();
          updateStats();
          updateBadges();
          renderItem(getNextItem());
        });
      }

      if (playerDeleteBtn) {
        playerDeleteBtn.addEventListener("click", function () {
          if (!activePlayerId || !players[activePlayerId]) return;
          if (Object.keys(players).length === 1) {
            alert("You need at least one player profile.");
            return;
          }
          if (!confirm("Delete player '" + players[activePlayerId].name + "' and their progress?")) return;

          delete players[activePlayerId];
          var remainingIds = Object.keys(players);
          activePlayerId = remainingIds[0];
          var active = players[activePlayerId];
          state = Object.assign(makeEmptyState(), active.state || {});
          if (!state.errorWeakness) state.errorWeakness = {};
          refreshPlayerSelect();
          syncSelectorsFromState();
          updateStats();
          updateBadges();
          renderItem(getNextItem());
        });
      }

      // Initial render
      loadPlayers();
      refreshPlayerSelect();
      syncSelectorsFromState();
      applyVisualToggles();
      updateStats();
      updateBadges();
      updateScoreboard();
      renderItem(getNextItem());
    });
  </script>
</body>
</html>
