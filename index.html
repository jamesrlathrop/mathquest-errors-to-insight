<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MathQuest – Errors to Insight</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --mq-bg: #020617;
      --mq-panel: #020617;
      --mq-accent: #22c55e;
      --mq-accent-soft: rgba(34, 197, 94, 0.12);
      --mq-border: #1f2937;
      --mq-text: #e5e7eb;
      --mq-muted: #9ca3af;
      --mq-scale: 1;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #020617 0, #020617 50%, #000 100%);
      color: var(--mq-text);
    }

    /* High contrast: strong black/white flip */
    body.mq-high-contrast {
      background: #000 !important;
      color: #fff !important;
    }

    body.mq-high-contrast .mq-topbar,
    body.mq-high-contrast .mq-shell {
      background: #000 !important;
    }

    body.mq-high-contrast .mq-panel,
    body.mq-high-contrast .mq-game-card {
      background: #000 !important;
      border-color: #ffffff !important;
      box-shadow: none !important;
    }

    body.mq-high-contrast .mq-question-text,
    body.mq-high-contrast .mq-work,
    body.mq-high-contrast .mq-panel-title,
    body.mq-high-contrast .mq-panel-sub,
    body.mq-high-contrast .mq-stat-pill,
    body.mq-high-contrast .mq-stat-value,
    body.mq-high-contrast .mq-badge-chip,
    body.mq-high-contrast .mq-footer-note,
    body.mq-high-contrast #mq-queue-note,
    body.mq-high-contrast #mq-scoreboard {
      color: #ffffff !important;
      border-color: #ffffff !important;
    }

    body.mq-high-contrast .mq-option-btn {
      background: #000000 !important;
      color: #ffffff !important;
      border-color: #ffffff !important;
    }

    body.mq-high-contrast .mq-option-btn.mq-correct {
      background: #00ff00 !important;
      color: #000000 !important;
      border-color: #00ff00 !important;
    }

    body.mq-high-contrast .mq-option-btn.mq-incorrect {
      background: #ff0033 !important;
      color: #ffffff !important;
      border-color: #ff0033 !important;
    }

    body.mq-high-contrast .mq-small-btn,
    body.mq-high-contrast .mq-reset-btn {
      background: #000000 !important;
      color: #ffffff !important;
      border-color: #ffffff !important;
    }

    body.mq-high-contrast .mq-modebar {
      border-color: #ffffff !important;
    }

    body.mq-high-contrast .mq-mode-btn {
      color: #ffffff !important;
    }

    body.mq-high-contrast .mq-mode-btn-active {
      background: #ffffff !important;
      color: #000000 !important;
    }

    /* Dyslexic mode: more distinctive font & spacing */
    body.mq-dyslexic {
      font-family: "OpenDyslexic", "Comic Sans MS", "Arial Rounded MT Bold",
        system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      line-height: 1.5;
    }

    body.mq-dyslexic #mq-root {
      letter-spacing: 0.02em;
    }

    #mq-root {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      transform-origin: top center;
      transform: scale(var(--mq-scale));
    }

    .mq-topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 16px;
      border-bottom: 1px solid var(--mq-border);
      background: #020617;
      position: sticky;
      top: 0;
      z-index: 20;
    }

    .mq-topbar-title {
      font-weight: 600;
      letter-spacing: 0.03em;
      font-size: 15px;
      color: #e5e7eb;
    }

    .mq-modebar {
      display: inline-flex;
      gap: 4px;
      border-radius: 999px;
      padding: 2px;
      background: #020617;
      border: 1px solid #1f2937;
    }

    .mq-mode-btn {
      border: none;
      background: transparent;
      color: #9ca3af;
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .mq-mode-btn-active {
      background: var(--mq-accent-soft);
      color: #bbf7d0;
      font-weight: 600;
    }

    .mq-mode-btn:hover {
      background: #020617;
      color: #e5e7eb;
    }

    .mq-shell {
      display: flex;
      flex: 1;
      padding: 12px;
      gap: 12px;
    }

    .mq-column {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .mq-column-left {
      width: 260px;
      max-width: 35%;
    }

    .mq-column-center {
      flex: 1;
      min-width: 0;
    }

    .mq-column-right {
      width: 260px;
      max-width: 35%;
    }

    @media (max-width: 900px) {
      .mq-shell {
        flex-direction: column;
      }
      .mq-column-left,
      .mq-column-right {
        width: 100%;
        max-width: 100%;
      }
    }

    .mq-panel {
      background: rgba(15, 23, 42, 0.95);
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.22);
      padding: 10px 12px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.7);
    }

    .mq-panel-title {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #9ca3af;
      margin-bottom: 6px;
    }

    .mq-panel-sub {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 8px;
    }

    .mq-field {
      margin-bottom: 8px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .mq-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: #9ca3af;
    }

    .mq-player-row {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .mq-player-row select {
      flex: 1;
    }

    select,
    input[type="range"] {
      width: 100%;
      padding: 4px 6px;
      border-radius: 8px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      font-size: 13px;
    }

    .mq-toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .mq-toggle-row label {
      font-size: 12px;
      color: #9ca3af;
    }

    .mq-toggle-row input[type="checkbox"] {
      transform: scale(1.1);
    }

    .mq-game-card {
      background: rgba(15, 23, 42, 0.95);
      border-radius: 20px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      padding: 14px 16px 16px;
      box-shadow: 0 22px 50px rgba(15, 23, 42, 0.8);
    }

    .mq-game-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .mq-game-title {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #9ca3af;
    }

    #game-container {
      width: 100%;
      height: 180px;
      border-radius: 16px;
      border: 1px solid #1f2937;
      background: radial-gradient(circle at top, #020617 0, #020617 50%, #000 100%);
      margin-bottom: 10px;
      overflow: hidden;
    }

    .mq-question-text {
      font-size: 14px;
      margin-bottom: 6px;
      color: #e5e7eb;
    }

    .mq-work {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 13px;
      padding: 6px 8px;
      border-radius: 8px;
      background: #020617;
      border: 1px solid #111827;
      color: #e5e7eb;
      margin-bottom: 6px;
    }

    .mq-options {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 6px;
      margin-bottom: 8px;
    }

    .mq-option-btn {
      text-align: left;
      border-radius: 10px;
      border: 1px solid #1f2937;
      padding: 8px 10px;
      background: #020617;
      color: #e5e7eb;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.14s ease, border-color 0.14s ease, transform 0.07s ease;
    }

    .mq-option-btn:hover:not(:disabled) {
      background: #020617;
      border-color: #334155;
      transform: translateY(-1px);
    }

    .mq-option-btn:disabled {
      opacity: 0.8;
      cursor: default;
    }

    .mq-option-btn.mq-correct {
      background: rgba(34, 197, 94, 0.12);
      border-color: #22c55e;
    }

    .mq-option-btn.mq-incorrect {
      background: rgba(239, 68, 68, 0.12);
      border-color: #f97373;
    }

    .mq-feedback {
      font-size: 12px;
      color: #9ca3af;
      min-height: 18px;
    }

    .mq-feedback-correct {
      color: #bbf7d0;
    }

    .mq-feedback-encouraging {
      color: #facc15;
    }

    .mq-queue-note {
      font-size: 11px;
      color: #6b7280;
      margin-top: 2px;
    }

    .mq-insight-log {
      font-size: 11px;
      color: #9ca3af;
      max-height: 120px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .mq-badges-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .mq-badge-chip {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      color: #9ca3af;
      background: #020617;
      white-space: nowrap;
    }

    .mq-badge-earned {
      background: rgba(34, 197, 94, 0.16);
      color: #bbf7d0;
      border-color: #22c55e;
    }

    .mq-stat-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }

    .mq-stat-pill {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid #1f2937;
      color: #9ca3af;
    }

    .mq-stat-value {
      color: #e5e7eb;
      font-weight: 500;
      margin-left: 4px;
    }

    .mq-reset-btn,
    .mq-small-btn {
      border-radius: 999px;
      border: 1px solid #1f2937;
      padding: 4px 10px;
      background: #020617;
      color: #e5e7eb;
      font-size: 11px;
      cursor: pointer;
    }

    .mq-reset-btn:hover,
    .mq-small-btn:hover {
      background: #111827;
    }

    .mq-reset-btn {
      border-color: #f97373;
      color: #fecaca;
    }

    .mq-sfx-on {
      border-color: #22c55e;
      color: #bbf7d0;
    }

    .mq-footer-note {
      font-size: 10px;
      color: #6b7280;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div id="mq-root">
    <!-- Top Mode bar -->
    <div class="mq-topbar">
      <div class="mq-topbar-title">
        MathQuest – Errors to Insight
      </div>
      <div class="mq-modebar">
        <button class="mq-mode-btn mq-mode-btn-active" type="button">
          Math
        </button>
        <a class="mq-mode-btn" href="https://example.com/classic/index.html">
          Classic
        </a>
        <a class="mq-mode-btn" href="https://example.com/classic/index_sweep.html">
          Sweep
        </a>
      </div>
    </div>

    <div class="mq-shell">
      <!-- Left column: controls -->
      <div class="mq-column mq-column-left">
        <div class="mq-panel">
          <div class="mq-panel-title">Session Settings</div>
          <div class="mq-panel-sub">Choose player, grade band, track, and how the game looks.</div>

          <div class="mq-field">
            <span class="mq-label">Player</span>
            <div class="mq-player-row">
              <select id="mq-player"></select>
              <button id="mq-player-add" type="button" class="mq-small-btn">+</button>
              <button id="mq-player-delete" type="button" class="mq-small-btn">–</button>
            </div>
          </div>

          <div class="mq-field">
            <span class="mq-label">Grade Band</span>
            <select id="mq-grade">
              <option value="K-2">K–2</option>
              <option value="3-5">3–5</option>
              <option value="6-8">6–8</option>
              <option value="Alg1">Algebra I</option>
              <option value="Geo">Geometry</option>
              <option value="Alg2">Algebra II</option>
              <option value="PreCalc">Pre-Calc / Calc</option>
            </select>
          </div>

          <div class="mq-field">
            <span class="mq-label">Track</span>
            <select id="mq-track">
              <option value="operations">Operations</option>
              <option value="reasoning">Reasoning</option>
            </select>
          </div>

          <div class="mq-field">
            <span class="mq-label">Explanation Time (sec)</span>
            <input id="mq-delay" type="range" min="3" max="20" value="5" />
          </div>

          <div class="mq-field">
            <span class="mq-label">UI Scale</span>
            <input id="mq-scale" type="range" min="80" max="130" value="100" />
          </div>

          <div class="mq-panel-sub">Accessibility</div>

          <div class="mq-toggle-row">
            <label for="mq-high-contrast">High contrast</label>
            <input id="mq-high-contrast" type="checkbox" />
          </div>
          <div class="mq-toggle-row">
            <label for="mq-dyslexic">Dyslexic-friendly font</label>
            <input id="mq-dyslexic" type="checkbox" />
          </div>

          <div style="margin-top: 8px; display: flex; gap: 6px; flex-wrap: wrap;">
            <button id="mq-sfx-toggle" type="button" class="mq-small-btn">
              SFX: ON
            </button>
            <button id="mq-reset" type="button" class="mq-reset-btn">
              Reset Progress
            </button>
          </div>

          <div class="mq-footer-note" id="mq-autosave">
            Ready.
          </div>
          <div class="mq-footer-note">
            Player profiles and progress are stored only on this device (localStorage).
          </div>
        </div>
      </div>

      <!-- Center column: main game -->
      <div class="mq-column mq-column-center">
        <div class="mq-game-card">
          <div class="mq-game-header">
            <div class="mq-game-title">Current Challenge</div>
            <div style="font-size: 11px; color: #6b7280;" id="mq-queue-note">
              Loading your first error…
            </div>
          </div>

          <div id="game-container"></div>

          <div class="mq-question-text" id="mq-question">
            Loading your first error…
          </div>
          <div class="mq-work" id="mq-work">
            Student work will appear here.
          </div>

          <div class="mq-options" id="mq-options"></div>

          <div class="mq-feedback" id="mq-feedback">
            Pick the best explanation or fix for the student's work.
          </div>

          <div style="margin-top: 6px; display: flex; justify-content: flex-end;">
            <button id="mq-next" type="button" class="mq-small-btn" disabled>
              Next ▶
            </button>
          </div>
        </div>

        <div class="mq-panel" style="margin-top: 10px;">
          <div class="mq-panel-title">Insights</div>
          <div class="mq-panel-sub">
            Each time you fix an error, the insight appears here for quick review.
          </div>
          <div class="mq-insight-log" id="mq-insight-log"></div>
        </div>
      </div>

      <!-- Right column: stats, badges, scoreboard, teacher -->
      <div class="mq-column mq-column-right">
        <div class="mq-panel">
          <div class="mq-panel-title">Session Stats</div>
          <div class="mq-stat-row">
            <div class="mq-stat-pill">
              XP
              <span class="mq-stat-value" id="mq-xp">0</span>
            </div>
            <div class="mq-stat-pill">
              Coins
              <span class="mq-stat-value" id="mq-coins">0</span>
            </div>
            <div class="mq-stat-pill">
              Streak
              <span class="mq-stat-value" id="mq-streak">0</span>
            </div>
            <div class="mq-stat-pill">
              Played
              <span class="mq-stat-value" id="mq-played">0</span>
            </div>
          </div>
        </div>

        <div class="mq-panel" style="margin-top: 10px;">
          <div class="mq-panel-title">Badges</div>
          <div class="mq-panel-sub">
            Earn badges for streaks, XP milestones, and working your Fix-It Queue.
          </div>
          <div class="mq-badges-row" id="mq-badges"></div>
        </div>

        <div class="mq-panel" style="margin-top: 10px;">
          <div class="mq-panel-title">Scoreboard</div>
          <div class="mq-panel-sub">
            Local players on this device, sorted by XP.
          </div>
          <div id="mq-scoreboard" style="font-size: 11px; color: #9ca3af; line-height: 1.4;">
            No players yet.
          </div>
          <div class="mq-footer-note">
            This scoreboard never leaves this browser. It is not shared online.
          </div>
        </div>

        <div class="mq-panel" style="margin-top: 10px;">
          <div class="mq-panel-title">Teacher Instructions</div>
          <div class="mq-panel-sub">
            Quick guidance for using MathQuest in class or at home.
          </div>
          <div style="font-size: 11px; color: #9ca3af; line-height: 1.4;">
            <ul style="padding-left: 18px; margin: 0;">
              <li>Start with one grade band and track (e.g., 6–8, Operations) for a short 5–10 minute warm-up.</li>
              <li>Ask students to think like graders: “What comment would you write on this work?”</li>
              <li>When they miss an item, pause and read the hint and insight together before moving on.</li>
              <li>Use the Fix-It Queue note to talk about common class errors you want to reduce.</li>
              <li>Invite students to explain, in words, <em>why</em> the chosen explanation fits the student’s work.</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Phaser 3 (loaded but not required yet for animations) -->
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.80.0/dist/phaser.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // ----- Seed items with difficulty + errorType -----
      var ITEMS = [
        // K–2 Operations
        {
          id: "k2-op-1",
          gradeBand: "K-2",
          track: "operations",
          difficulty: "easy",
          errorType: "digit-append",
          inattention: false,
          prompt: "A student writes 7 + 5 = 75. What went wrong?",
          work: "Student work: 7 + 5 = 75",
          options: [
            "They wrote the digits side by side instead of actually adding 7 and 5.",
            "They subtracted 5 from 7 instead of adding.",
            "They multiplied 7 × 5 instead of adding.",
            "They changed the 5 into 50 before adding."
          ],
          correctIndex: 0,
          hint: "First think: what is 7 + 5 really equal to?",
          insight:
            "They treated addition as 'sticking digits together'. The correct work is 7 + 5 = 12, not 75."
        },
        {
          id: "k2-op-2",
          gradeBand: "K-2",
          track: "operations",
          difficulty: "easy",
          errorType: "extra-zero",
          inattention: true,
          prompt: "A student solves 10 − 7 = 3, but writes 30 as the answer.",
          work: "Student work: 10 − 7 = 30",
          options: [
            "They added an extra zero out of habit, making the answer ten times too big.",
            "They subtracted 7 from the wrong number.",
            "They thought 3 and 30 mean the same amount.",
            "They added 7 instead of subtracting it."
          ],
          correctIndex: 0,
          hint: "Is 30 close to 10 or much bigger than 10?",
          insight:
            "They did the subtraction correctly (10 − 7 = 3) but then tacked on a zero. Adding a zero turns 3 into 30, which is ten times too large."
        },

        // K–2 Reasoning
        {
          id: "k2-re-1",
          gradeBand: "K-2",
          track: "reasoning",
          difficulty: "easy",
          errorType: "place-value-language",
          inattention: false,
          prompt: "A student says 15 is 'one ten and five ones', then writes 105.",
          work: "Student work: 15 = 105",
          options: [
            "They tried to show tens and ones by writing all three digits, instead of using 15.",
            "They subtracted 10 from 105.",
            "They thought 15 has one hundred and five ones.",
            "They meant 10 + 5 but forgot how to write it."
          ],
          correctIndex: 0,
          hint: "How do we usually write one ten and five ones as a number?",
          insight:
            "They mixed up the idea of place value with writing digits. The number 15 already means 1 ten and 5 ones, so 105 is a different, much larger number."
        },

        // 3–5 Operations
        {
          id: "35-op-1",
          gradeBand: "3-5",
          track: "operations",
          difficulty: "medium",
          errorType: "carry-borrow",
          inattention: false,
          prompt: "A student solves 27 + 38 and writes 55.",
          work: "Student work: 27 + 38 = 55",
          options: [
            "They added only the tens and forgot to add and carry from the ones place.",
            "They subtracted 27 from 38 instead of adding.",
            "They multiplied the digits in each number.",
            "They rounded both numbers first and never went back to the exact ones."
          ],
          correctIndex: 0,
          hint: "Add the ones (7 + 8) first. What happens to the 1 in 15?",
          insight:
            "They added the tens (20 + 30 = 50) but didn’t handle 7 + 8 correctly or carry the 1. Correct work: 7 + 8 = 15, write 5 and carry 1, then 2 + 3 + 1 = 6 tens. The real sum is 65."
        },

        // 3–5 Reasoning
        {
          id: "35-re-1",
          gradeBand: "3-5",
          track: "reasoning",
          difficulty: "medium",
          errorType: "percent-decimal",
          inattention: false,
          prompt: "A student says 0.5 is the same as 5%.",
          work: "Student idea: 0.5 = 5%",
          options: [
            "They forgot that 0.5 means 50%, not 5%.",
            "They added 50 instead of 5.",
            "They turned 5% into 0.05 and got confused.",
            "They mixed up numerator and denominator in a fraction."
          ],
          correctIndex: 0,
          hint: "Think about one-half of something. Is that closer to 5% or 50%?",
          insight:
            "They treated the percent sign as just a label. 0.5 is one-half, which is 50%. Five percent would be 0.05, which is much smaller."
        },

        // 6–8 Operations
        {
          id: "68-op-1",
          gradeBand: "6-8",
          track: "operations",
          difficulty: "medium",
          errorType: "fraction-addition",
          inattention: false,
          prompt: "A student adds fractions and gets 1/4 + 1/2 = 2/6.",
          work: "Student work: 1/4 + 1/2 = 2/6",
          options: [
            "They added the numerators and denominators straight across instead of using a common denominator.",
            "They multiplied the fractions instead of adding them.",
            "They subtracted one fraction from the other.",
            "They tried to simplify 3/4 but used the wrong numbers."
          ],
          correctIndex: 0,
          hint: "What denominator can both 1/4 and 1/2 be rewritten with?",
          insight:
            "They treated fraction addition like (1+1)/(4+2). For addition, we keep a common denominator: 1/4 + 1/2 = 1/4 + 2/4 = 3/4. So the correct sum is 3/4, not 2/6."
        },
        {
          id: "68-op-2",
          gradeBand: "6-8",
          track: "operations",
          difficulty: "medium",
          errorType: "integer-sign",
          inattention: true,
          prompt: "A student computes −8 + 5 and writes −13.",
          work: "Student work: −8 + 5 = −13",
          options: [
            "They added the numbers as if both were negative, instead of combining a negative and a positive.",
            "They subtracted 5 from 8 but forgot to keep the negative sign.",
            "They multiplied −8 by 5 instead of adding.",
            "They changed −8 into +8 by mistake."
          ],
          correctIndex: 0,
          hint: "Think about which number has the greater absolute value: 8 or 5.",
          insight:
            "They treated −8 and +5 as if both were negative, so they just added 8 + 5 = 13 and kept the minus sign. The correct idea: the negative is stronger by 3, so −8 + 5 = −3."
        },
        {
          id: "68-op-3",
          gradeBand: "6-8",
          track: "operations",
          difficulty: "medium",
          errorType: "distribution",
          inattention: false,
          prompt: "A student solves 3(x − 4) and writes 3x − 4.",
          work: "Student work: 3(x − 4) = 3x − 4",
          options: [
            "They multiplied 3 by x but forgot to multiply 3 by −4.",
            "They subtracted 4 from 3x incorrectly.",
            "They added 4 to both sides of the equation.",
            "They only distributed 4 and not 3."
          ],
          correctIndex: 0,
          hint: "Distribution must touch every term inside the parentheses.",
          insight:
            "They only applied the 3 to x. Correct distribution multiplies each term: 3(x − 4) = 3x − 12. Forgetting 3·(−4) is a common procedural slip."
        },
        {
          id: "68-op-4",
          gradeBand: "6-8",
          track: "operations",
          difficulty: "medium",
          errorType: "distribution",
          inattention: false,
          prompt: "A student simplifies 5(2x + 1) and writes 10x + 1.",
          work: "Student work: 5(2x + 1) = 10x + 1",
          options: [
            "They multiplied the variable term correctly but forgot to multiply the constant by 5.",
            "They multiplied everything by 10 instead of 5.",
            "They added 5 to 2x and left the +1 alone.",
            "They distributed 5 only to the 1 and not to 2x."
          ],
          correctIndex: 0,
          hint: "How many terms are inside the parentheses, and what should 5 be multiplied by?",
          insight:
            "They handled 5·2x = 10x but treated +1 as if it stayed the same. The correct expansion is 5(2x + 1) = 10x + 5."
        },

        // 6–8 Reasoning
        {
          id: "68-re-1",
          gradeBand: "6-8",
          track: "reasoning",
          difficulty: "medium",
          errorType: "square-negative",
          inattention: false,
          prompt: "A student says (−3)² = −9 because 'the answer stays negative'.",
          work: "Student work: (−3)² = −9",
          options: [
            "They forgot that squaring multiplies the number by itself, so a negative times a negative is positive.",
            "They multiplied 3 × 2 instead of squaring.",
            "They changed the sign twice in the wrong places.",
            "They squared only the negative sign and not the 3."
          ],
          correctIndex: 0,
          hint: "Write (−3)² as (−3) × (−3). What is the sign of that product?",
          insight:
            "They assumed 'negative stays negative' even when squaring. But (−3) × (−3) = +9, so (−3)² = 9, not −9."
        },
        {
          id: "68-re-2",
          gradeBand: "6-8",
          track: "reasoning",
          difficulty: "medium",
          errorType: "graph-yintercept",
          inattention: true,
          prompt: "A student graphs the line y = 2x − 3 but draws a line through (0, 2) instead of (0, −3).",
          work: "Student work: y-intercept shown at (0, 2)",
          options: [
            "They misread the y-intercept and plotted +2 instead of −3.",
            "They used the slope as the intercept by mistake.",
            "They graphed x = 2 instead of y = 2x − 3.",
            "They reflected the line across the y-axis."
          ],
          correctIndex: 0,
          hint: "Where should the line cross the y-axis if b = −3?",
          insight:
            "They treated −3 as +2, which is a sign and copying mistake rather than a slope error. The correct intercept is at (0, −3). Once you start there, slope 2 completes the line."
        },
        {
          id: "68-re-3",
          gradeBand: "6-8",
          track: "reasoning",
          difficulty: "hard",
          errorType: "proportion",
          inattention: false,
          prompt: "A student claims that if you double the x-value in a proportional relationship, the y-value always stays the same.",
          work: "Student statement: 'y doesn't change when x doubles.'",
          options: [
            "They forgot that in a proportional relationship, y changes with x at a constant rate.",
            "They mixed up proportional relationships with horizontal lines.",
            "They confused 'double' with 'divide by 2'.",
            "They thought only the ratio y/x matters, not the actual values."
          ],
          correctIndex: 0,
          hint: "In y = kx, what happens to y if x is multiplied by 2?",
          insight:
            "They ignored the idea that y depends on x. In y = kx, doubling x doubles y. Their reasoning treats y as fixed, which is more like a horizontal line than a proportional relationship."
        },

        // Algebra I Operations
        {
          id: "alg1-op-1",
          gradeBand: "Alg1",
          track: "operations",
          difficulty: "medium",
          errorType: "distribution",
          inattention: false,
          prompt: "A student expands 2(x + 3) as 2x + 3.",
          work: "Student work: 2(x + 3) = 2x + 3",
          options: [
            "They distributed 2 to x but forgot to multiply 3 by 2 as well.",
            "They added 2 to x and then added 3.",
            "They subtracted 3 instead of adding it.",
            "They divided everything by 2 first."
          ],
          correctIndex: 0,
          hint: "How many terms are inside the parentheses, and what should 2 touch?",
          insight:
            "They only multiplied the x. Correct distribution multiplies each term: 2(x + 3) = 2x + 6."
        },
        {
          id: "alg1-op-2",
          gradeBand: "Alg1",
          track: "operations",
          difficulty: "medium",
          errorType: "linear-equation-steps",
          inattention: false,
          prompt: "A student solves 2x + 5 = 11 and writes x = 11 − 5 ÷ 2.",
          work: "Student work: x = 11 − 5 ÷ 2",
          options: [
            "They treated 'divide by 2' as affecting only the 5, instead of the entire left side.",
            "They subtracted 5 from 11 incorrectly.",
            "They multiplied everything by 2 instead of dividing.",
            "They changed 2x into x² by mistake."
          ],
          correctIndex: 0,
          hint: "Think about undoing 2x + 5 step by step: which operation do you undo first?",
          insight:
            "They tried to solve in one line but let the order of operations take over. Correct solving uses inverse steps: subtract 5 from both sides (2x = 6), then divide the whole equation by 2 to get x = 3."
        },

        // Algebra I Reasoning
        {
          id: "alg1-re-1",
          gradeBand: "Alg1",
          track: "reasoning",
          difficulty: "hard",
          errorType: "equivalent-forms",
          inattention: false,
          prompt: "A student says the equation y = 4x + 1 and 4x − y = −1 represent different lines.",
          work: "Student work: treats y = 4x + 1 and 4x − y = −1 as different",
          options: [
            "They didn’t recognize that rearranging an equation can produce an equivalent form of the same line.",
            "They thought subtracting y always changes the slope.",
            "They confused x-intercept with y-intercept.",
            "They assumed any minus sign makes a new line."
          ],
          correctIndex: 0,
          hint: "Try solving 4x − y = −1 for y. What do you get?",
          insight:
            "They didn’t see that 4x − y = −1 can be rearranged: subtract 4x from both sides to get −y = −4x − 1, then multiply by −1 to get y = 4x + 1. It’s the same line written in a different form."
        },
        {
          id: "alg1-re-2",
          gradeBand: "Alg1",
          track: "reasoning",
          difficulty: "hard",
          errorType: "sign-slip",
          inattention: true,
          prompt: "A student graphs y = −2x + 4 but draws the line increasing instead of decreasing.",
          work: "Student graph: line with positive slope through (0,4)",
          options: [
            "They treated the slope −2 as if it were +2 when drawing the line.",
            "They started at the wrong y-intercept on the graph.",
            "They graphed x = −2 instead of y = −2x + 4.",
            "They forgot to mark the intercept at 4 on the y-axis."
          ],
          correctIndex: 0,
          hint: "When slope is negative, does the line go up or down as you move to the right?",
          insight:
            "They recognized the intercept but ignored the negative sign in the slope and drew a line that rises. For y = −2x + 4, the line should go down 2 units for every 1 you move right."
        },

        // Geometry Operations
        {
          id: "geo-op-1",
          gradeBand: "Geo",
          track: "operations",
          difficulty: "medium",
          errorType: "perimeter-area",
          inattention: false,
          prompt: "A student finds the perimeter of a rectangle with sides 3 and 5 by computing 3 × 5 = 15.",
          work: "Student work: Perimeter = 15",
          options: [
            "They used the area formula (length × width) instead of adding all the side lengths.",
            "They added the sides in the wrong order.",
            "They subtracted 3 from 5 instead.",
            "They halved the side lengths before adding."
          ],
          correctIndex: 0,
          hint: "For perimeter, think about walking all the way around the shape.",
          insight:
            "They used multiplication, which gives the area. Perimeter is 3 + 5 + 3 + 5 = 16 units, not 15."
        },
        {
          id: "geo-op-2",
          gradeBand: "Geo",
          track: "operations",
          difficulty: "hard",
          errorType: "pythagorean",
          inattention: false,
          prompt: "A student uses the Pythagorean theorem with legs 6 and 8 but writes 6² + 8² = 10.",
          work: "Student work: 6² + 8² = 10",
          options: [
            "They added 6 and 8 first to get 14, then mis-simplified to 10.",
            "They forgot to square the legs in the theorem.",
            "They treated c as 10 and wrote the equation backwards.",
            "They only squared one of the legs."
          ],
          correctIndex: 0,
          hint: "Compute 6² and 8² separately. What should you add?",
          insight:
            "They ignored the actual squares and jumped to a simple number. Correct work: 6² = 36, 8² = 64, so 36 + 64 = 100 and c = 10. Writing 6² + 8² = 10 skips the square step entirely."
        },

        // Geometry Reasoning
        {
          id: "geo-re-1",
          gradeBand: "Geo",
          track: "reasoning",
          difficulty: "medium",
          errorType: "triangle-angle-sum",
          inattention: false,
          prompt: "A student says the angles in a triangle add to 200° because '100 + 50 + 50 = 200'.",
          work: "Student work: angle sum = 200°",
          options: [
            "They added the example angles correctly but forgot the rule that triangles must sum to 180°.",
            "They used angle measures from a quadrilateral instead.",
            "They mixed up degrees and radians.",
            "They accidentally doubled one of the angles."
          ],
          correctIndex: 0,
          hint: "What is the standard angle sum for any triangle?",
          insight:
            "They focused on the numbers they picked (100°, 50°, 50°) and ignored the 180° triangle rule. Even if their addition is fine, any triangle must have angles that total 180°, so these measures cannot form a triangle."
        },
        {
          id: "geo-re-2",
          gradeBand: "Geo",
          track: "reasoning",
          difficulty: "hard",
          errorType: "given-info-missed",
          inattention: true,
          prompt: "A student forgets to mark a given right angle in a diagram and treats the triangle as if it were not right.",
          work: "Student work: uses non-right triangle formulas instead of right triangle methods",
          options: [
            "They overlooked the right angle condition and chose a formula that doesn’t use a right angle.",
            "They misread the labels on the sides.",
            "They confused side length with angle measure.",
            "They assumed all triangles are isosceles."
          ],
          correctIndex: 0,
          hint: "Does the problem mention or show a right angle anywhere?",
          insight:
            "This is an inattention error: the student missed the right-angle information. Once you notice it’s a right triangle, using the Pythagorean theorem or right-triangle trig is much simpler than general formulas."
        },

        // Algebra II Operations
        {
          id: "alg2-op-1",
          gradeBand: "Alg2",
          track: "operations",
          difficulty: "medium",
          errorType: "expansion",
          inattention: false,
          prompt: "A student expands (x + 2)² and writes x² + 4.",
          work: "Student work: (x + 2)² = x² + 4",
          options: [
            "They squared each term but forgot the middle term 2·x·2.",
            "They multiplied x by 2 and then squared.",
            "They added 2 to x² instead of squaring.",
            "They confused (x + 2)² with (x² + 2)²."
          ],
          correctIndex: 0,
          hint: "Recall the pattern (a + b)² = a² + 2ab + b².",
          insight:
            "They treated (x + 2)² as if you only square each piece: x² + 4. The missing middle term is 2·x·2 = 4x, so the full expansion should be x² + 4x + 4."
        },

        // Algebra II Reasoning
        {
          id: "alg2-re-1",
          gradeBand: "Alg2",
          track: "reasoning",
          difficulty: "hard",
          errorType: "factored-form",
          inattention: false,
          prompt: "A student simplifies (x − 3)(x + 3) and writes x² + 9.",
          work: "Student work: (x − 3)(x + 3) = x² + 9",
          options: [
            "They squared each number individually and ignored the cross terms.",
            "They added the binomials first, then squared.",
            "They multiplied only the x terms together.",
            "They thought 3x and −3x cancel incorrectly."
          ],
          correctIndex: 0,
          hint: "FOIL or expand: (x − 3)(x + 3) = x·x + x·3 − 3·x − 3·3.",
          insight:
            "They treated it like (x² + 3²). The cross terms x·3 and −3·x cancel, leaving x² − 9, not x² + 9. This pattern is a classic: (a − b)(a + b) = a² − b²."
        },

        // Pre-Calc / Calc Operations
        {
          id: "precalc-op-1",
          gradeBand: "PreCalc",
          track: "operations",
          difficulty: "hard",
          errorType: "derivative-rule",
          inattention: false,
          prompt: "A student says the derivative of f(x) = x² is f′(x) = 2x².",
          work: "Student work: d/dx (x²) = 2x²",
          options: [
            "They multiplied by the exponent but forgot to reduce the power by 1.",
            "They differentiated twice in a row.",
            "They integrated instead of differentiating.",
            "They changed x² into 2x before differentiating."
          ],
          correctIndex: 0,
          hint: "Recall the power rule: d/dx (xⁿ) = n·x^(n−1).",
          insight:
            "They only used half of the power rule. The correct derivative is 2x^(2−1) = 2x, not 2x²."
        },

        // Pre-Calc / Calc Reasoning
        {
          id: "precalc-re-1",
          gradeBand: "PreCalc",
          track: "reasoning",
          difficulty: "hard",
          errorType: "angle-mixup",
          inattention: true,
          prompt: "A student evaluates sin(π) and writes 1, because 'π is 180°, the top of the circle.'",
          work: "Student work: sin(π) = 1",
          options: [
            "They confused the sine value at π/2 (90°) with the value at π (180°).",
            "They used cosine instead of sine.",
            "They mixed up radians and degrees entirely.",
            "They thought sine is always 1 at important angles."
          ],
          correctIndex: 0,
          hint: "On the unit circle, what are the coordinates at π (180°)?",
          insight:
            "They remembered that sin(π/2) = 1 and extended it to π. On the unit circle, π is at (−1, 0), so sin(π) = 0. This is partly inattention (mixing angles) and partly a reminder to link sine to the y-coordinate."
        }
      ];

      function makeEmptyState() {
        return {
          xp: 0,
          coins: 0,
          streak: 0,
          played: 0,
          gradeBand: "K-2",
          track: "operations",
          missed: [],
          errorWeakness: {}
        };
      }

      function isInattentionItem(item) {
        return !!(item && item.inattention);
      }

      var state = makeEmptyState();
      var STORAGE_KEY = "mathquest_players_v1";
      var players = {};
      var activePlayerId = null;
      var lastItemId = null;

      function $(id) {
        return document.getElementById(id);
      }

      var els = {
        grade: $("mq-grade"),
        track: $("mq-track"),
        question: $("mq-question"),
        work: $("mq-work"),
        options: $("mq-options"),
        feedback: $("mq-feedback"),
        queueNote: $("mq-queue-note"),
        xp: $("mq-xp"),
        coins: $("mq-coins"),
        streak: $("mq-streak"),
        played: $("mq-played"),
        badges: $("mq-badges"),
        autosave: $("mq-autosave"),
        highContrast: $("mq-high-contrast"),
        dyslexic: $("mq-dyslexic"),
        reset: $("mq-reset"),
        insightLog: $("mq-insight-log"),
        scoreboard: $("mq-scoreboard")
      };

      var scaleSlider = $("mq-scale");
      var delaySlider = $("mq-delay");
      var sfxButton = $("mq-sfx-toggle");
      var nextButton = $("mq-next");
      var sfxOn = true;
      var audioCtx = null;
      var nextTimer = null;
      var autoAdvanceDelayMs = 5000;

      function loadPlayers() {
        players = {};
        activePlayerId = null;

        try {
          var raw = localStorage.getItem(STORAGE_KEY);
          if (raw) {
            var parsed = JSON.parse(raw);
            if (parsed && typeof parsed === "object" && parsed.players) {
              players = parsed.players;
              activePlayerId = parsed.activeId || null;
            }
          }
        } catch (e) {
          players = {};
          activePlayerId = null;
        }

        if (!players || Object.keys(players).length === 0) {
          var id = "p1";
          players = {};
          players[id] = {
            name: "Player 1",
            state: makeEmptyState()
          };
          activePlayerId = id;
        }

        var active = players[activePlayerId];
        if (active && active.state) {
          state = Object.assign(makeEmptyState(), active.state);
          if (!state.errorWeakness) state.errorWeakness = {};
        } else {
          state = makeEmptyState();
        }
      }

      function savePlayers() {
        if (!activePlayerId || !players[activePlayerId]) return;
        players[activePlayerId].state = state;

        try {
          localStorage.setItem(
            STORAGE_KEY,
            JSON.stringify({
              activeId: activePlayerId,
              players: players
            })
          );
          if (els.autosave && players[activePlayerId]) {
            els.autosave.textContent =
              "Progress saved for " + players[activePlayerId].name + ".";
          }
        } catch (e) {
          if (els.autosave) {
            els.autosave.textContent = "Autosave skipped (storage unavailable).";
          }
        }
      }

      function refreshPlayerSelect() {
        var select = $("mq-player");
        if (!select) return;
        select.innerHTML = "";

        Object.keys(players).forEach(function (id) {
          var opt = document.createElement("option");
          opt.value = id;
          opt.textContent = players[id].name || id;
          if (id === activePlayerId) {
            opt.selected = true;
          }
          select.appendChild(opt);
        });
      }

      function syncSelectorsFromState() {
        if (els.grade) els.grade.value = state.gradeBand;
        if (els.track) els.track.value = state.track;
      }

      function updateScoreboard() {
        if (!els.scoreboard) return;

        var names = Object.keys(players);
        if (names.length === 0) {
          els.scoreboard.textContent = "No players yet.";
          return;
        }

        var summary = names.map(function (id) {
          var p = players[id];
          var st = p.state || makeEmptyState();
          return {
            name: p.name || id,
            xp: st.xp || 0,
            coins: st.coins || 0
          };
        });

        summary.sort(function (a, b) {
          if (b.xp !== a.xp) return b.xp - a.xp;
          if (b.coins !== a.coins) return b.coins - a.coins;
          return a.name.localeCompare(b.name);
        });

        var html = "<ol style='padding-left: 18px; margin: 0;'>";
        summary.forEach(function (p) {
          html +=
            "<li>" +
            p.name +
            " — XP " +
            p.xp +
            ", Coins " +
            p.coins +
            "</li>";
        });
        html += "</ol>";

        els.scoreboard.innerHTML = html;
      }

      function updateStats() {
        if (els.xp) els.xp.textContent = state.xp;
        if (els.coins) els.coins.textContent = state.coins;
        if (els.streak) els.streak.textContent = state.streak;
        if (els.played) els.played.textContent = state.played;
        savePlayers();
        updateScoreboard();
      }

      function updateBadges() {
        if (!els.badges) return;
        els.badges.innerHTML = "";
        var list = [];

        if (state.played >= 1) list.push("First Fix");
        if (state.streak >= 3) list.push("Streak 3+");
        if (state.streak >= 5) list.push("Streak 5+");
        if (state.xp >= 20) list.push("20+ XP");
        if (state.xp >= 50) list.push("50+ XP");
        if (state.missed && state.missed.length >= 3) list.push("Fix-It Queue");

        list.forEach(function (label) {
          var chip = document.createElement("div");
          chip.className = "mq-badge-chip mq-badge-earned";
          chip.textContent = "★ " + label;
          els.badges.appendChild(chip);
        });
      }

      function getPool() {
        return ITEMS.filter(function (item) {
          return item.gradeBand === state.gradeBand && item.track === state.track;
        });
      }

      function getTopWeakErrorTypes() {
        var map = state.errorWeakness || {};
        var types = Object.keys(map);
        if (types.length === 0) return [];
        var entries = types.map(function (t) {
          return { type: t, score: map[t] };
        });
        entries.sort(function (a, b) {
          return b.score - a.score;
        });
        var filtered = entries.filter(function (e) {
          return e.score >= 2;
        });
        if (filtered.length === 0) return [];
        return filtered.map(function (e) {
          return e.type;
        });
      }

      function pickDifficultyFromPool(pool) {
        if (!pool || pool.length === 0) return null;

        var present = { easy: false, medium: false, hard: false };
        pool.forEach(function (item) {
          if (item.difficulty && present.hasOwnProperty(item.difficulty)) {
            present[item.difficulty] = true;
          }
        });

        var streak = state.streak || 0;
        var weights = { easy: 0, medium: 0, hard: 0 };

        if (streak <= 1) {
          weights.easy = 0.7;
          weights.medium = 0.25;
          weights.hard = 0.05;
        } else if (streak <= 4) {
          weights.easy = 0.4;
          weights.medium = 0.4;
          weights.hard = 0.2;
        } else {
          weights.easy = 0.2;
          weights.medium = 0.4;
          weights.hard = 0.4;
        }

        var available = [];
        ["easy", "medium", "hard"].forEach(function (d) {
          if (present[d] && weights[d] > 0) {
            available.push({ difficulty: d, weight: weights[d] });
          }
        });

        if (available.length === 0) {
          var fallback = [];
          pool.forEach(function (item) {
            if (item.difficulty && present.hasOwnProperty(item.difficulty)) {
              if (fallback.indexOf(item.difficulty) === -1) {
                fallback.push(item.difficulty);
              }
            }
          });
          if (fallback.length === 0) return null;
          return fallback[Math.floor(Math.random() * fallback.length)];
        }

        var total = available.reduce(function (sum, d) {
          return sum + d.weight;
        }, 0);
        var r = Math.random() * total;
        var acc = 0;
        for (var i = 0; i < available.length; i++) {
          acc += available[i].weight;
          if (r <= acc) return available[i].difficulty;
        }
        return available[available.length - 1].difficulty;
      }

      function chooseAdaptiveFromPool(pool) {
        if (!pool || pool.length === 0) return null;

        var difficulty = pickDifficultyFromPool(pool);
        var candidates = pool;

        if (difficulty) {
          var filtered = pool.filter(function (item) {
            return item.difficulty === difficulty;
          });
          if (filtered.length > 0) {
            candidates = filtered;
          }
        }

        var weakTypes = getTopWeakErrorTypes();
        if (weakTypes.length > 0 && Math.random() < 0.5) {
          var focusType = weakTypes[0];
          var typeFiltered = candidates.filter(function (item) {
            return item.errorType === focusType;
          });
          if (typeFiltered.length > 0) {
            candidates = typeFiltered;
          }
        }

        // Avoid immediate repeats when possible
        if (candidates.length > 1 && lastItemId) {
          var diffCandidates = candidates.filter(function (item) {
            return item.id !== lastItemId;
          });
          if (diffCandidates.length > 0) {
            candidates = diffCandidates;
          }
        }

        var idx = Math.floor(Math.random() * candidates.length);
        return candidates[idx];
      }

      function getNextItem() {
        var fromMissed = false;
        var item = null;

        if (state.missed && state.missed.length > 0 && Math.random() < 0.4) {
          var idx = Math.floor(Math.random() * state.missed.length);
          item = state.missed[idx];
          fromMissed = true;
          state.missed.splice(idx, 1);
        } else {
          var pool = getPool();
          if (pool.length === 0) {
            return { item: null, fromMissed: false };
          }
          item =
            chooseAdaptiveFromPool(pool) ||
            pool[Math.floor(Math.random() * pool.length)];
        }

        return { item: item, fromMissed: fromMissed };
      }

      var currentItem = null;
      var awaitingAnswer = false;

      function appendInsightLog(item, correct) {
        if (!els.insightLog || !item) return;
        var div = document.createElement("div");
        div.style.marginBottom = "4px";
        var label = correct ? "✔️ Insight" : "🔁 Fix-It insight";
        div.innerHTML = "<strong>" + label + ":</strong> " + item.insight;
        els.insightLog.prepend(div);
      }

      function renderItem(next) {
        currentItem = next.item;
        awaitingAnswer = true;
        if (nextTimer) {
          clearTimeout(nextTimer);
          nextTimer = null;
        }
        if (nextButton) {
          nextButton.disabled = false;
        }

        if (!currentItem) {
          if (els.question) {
            els.question.textContent = "No items for this grade band and track yet.";
          }
          if (els.work) els.work.textContent = "";
          if (els.options) els.options.innerHTML = "";
          if (els.feedback) {
            els.feedback.textContent = "Try another grade band or track.";
            els.feedback.className = "mq-feedback";
          }
          if (els.queueNote) els.queueNote.textContent = "";
          return;
        }

        lastItemId = currentItem.id;

        if (els.question) els.question.textContent = currentItem.prompt;
        if (els.work) els.work.textContent = currentItem.work || "";
        if (els.feedback) {
          els.feedback.textContent = "Pick the best explanation or fix for this student's work.";
          els.feedback.className = "mq-feedback";
        }

        if (els.queueNote) {
          var inattentionLabel = "";
          if (isInattentionItem(currentItem)) {
            inattentionLabel =
              " <span style='color:#facc15;'>⚠ Inattention focus</span>";
          }

          if (next.fromMissed) {
            els.queueNote.innerHTML =
              "🔁 <strong>Fix-It Queue:</strong> back for another try." +
              inattentionLabel;
          } else {
            els.queueNote.innerHTML =
              "✨ New error from this grade band and track." + inattentionLabel;
          }
        }

        if (!els.options) return;
        els.options.innerHTML = "";

        currentItem.options.forEach(function (optText, index) {
          var btn = document.createElement("button");
          btn.type = "button";
          btn.className = "mq-option-btn";
          btn.textContent = optText;
          btn.addEventListener("click", function () {
            handleAnswer(index);
          });
          els.options.appendChild(btn);
        });
      }

      function playBeep(correct) {
        if (!sfxOn) return;
        try {
          if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          }
          var oscillator = audioCtx.createOscillator();
          var gain = audioCtx.createGain();
          oscillator.connect(gain);
          gain.connect(audioCtx.destination);

          oscillator.type = "square";
          oscillator.frequency.value = correct ? 1200 : 400;

          var now = audioCtx.currentTime;
          gain.gain.setValueAtTime(0.0001, now);
          gain.gain.exponentialRampToValueAtTime(0.5, now + 0.02);
          gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.3);

          oscillator.start(now);
          oscillator.stop(now + 0.32);
        } catch (e) {}
      }

      function scheduleNextItem() {
        if (nextTimer) {
          clearTimeout(nextTimer);
          nextTimer = null;
        }
        nextTimer = setTimeout(function () {
          var next = getNextItem();
          renderItem(next);
        }, autoAdvanceDelayMs);
      }

      function handleAnswer(selectedIndex) {
        if (!currentItem) return;

        awaitingAnswer = false;

        var buttons = els.options
          ? Array.prototype.slice.call(
              els.options.querySelectorAll(".mq-option-btn")
            )
          : [];

        var correct = selectedIndex === currentItem.correctIndex;

        buttons.forEach(function (btn, index) {
          btn.disabled = true;
          btn.classList.remove("mq-correct", "mq-incorrect");
          if (index === currentItem.correctIndex) {
            btn.classList.add("mq-correct");
          }
          if (!correct && index === selectedIndex) {
            btn.classList.add("mq-incorrect");
          }
        });

        playBeep(correct);
        state.played += 1;

        if (!state.errorWeakness) state.errorWeakness = {};
        if (!correct && currentItem.errorType) {
          if (!state.errorWeakness[currentItem.errorType]) {
            state.errorWeakness[currentItem.errorType] = 0;
          }
          state.errorWeakness[currentItem.errorType] += 1;
        }

        if (correct) {
          state.xp += 5;
          state.coins += 1;
          state.streak += 1;
          if (els.feedback) {
            els.feedback.textContent = "Nice fix! " + currentItem.insight;
            els.feedback.className = "mq-feedback mq-feedback-correct";
          }
          appendInsightLog(currentItem, true);
        } else {
          state.streak = 0;
          state.missed.push(currentItem);
          if (els.feedback) {
            els.feedback.textContent =
              "Good attempt. This is a common error. Hint: " + currentItem.hint;
            els.feedback.className = "mq-feedback mq-feedback-encouraging";
          }
          appendInsightLog(currentItem, false);
        }

        updateStats();
        updateBadges();
        scheduleNextItem();
      }

      function applyVisualToggles() {
        var body = document.body;
        if (els.highContrast) {
          if (els.highContrast.checked) {
            body.classList.add("mq-high-contrast");
          } else {
            body.classList.remove("mq-high-contrast");
          }
        }
        if (els.dyslexic) {
          if (els.dyslexic.checked) {
            body.classList.add("mq-dyslexic");
          } else {
            body.classList.remove("mq-dyslexic");
          }
        }
      }

      if (els.grade) {
        els.grade.addEventListener("change", function (e) {
          state.gradeBand = e.target.value;
          updateStats();
          var next = getNextItem();
          renderItem(next);
        });
      }

      if (els.track) {
        els.track.addEventListener("change", function (e) {
          state.track = e.target.value;
          updateStats();
          var next = getNextItem();
          renderItem(next);
        });
      }

      if (els.highContrast) {
        els.highContrast.addEventListener("change", applyVisualToggles);
      }

      if (els.dyslexic) {
        els.dyslexic.addEventListener("change", applyVisualToggles);
      }

      if (els.reset) {
        els.reset.addEventListener("click", function () {
          if (!confirm("Reset XP, coins, streak, and Fix-It Queue for this player?")) return;
          state = makeEmptyState();
          state.gradeBand = els.grade ? els.grade.value : "K-2";
          state.track = els.track ? els.track.value : "operations";
          if (els.insightLog) els.insightLog.innerHTML = "";
          updateStats();
          updateBadges();
          var next = getNextItem();
          renderItem(next);
        });
      }

      if (scaleSlider) {
        var initialScale = scaleSlider.value
          ? parseInt(scaleSlider.value, 10) / 100
          : 1;
        document.documentElement.style.setProperty("--mq-scale", initialScale);

        scaleSlider.addEventListener("input", function (e) {
          var value = parseInt(e.target.value, 10) || 100;
          var scale = value / 100;
          document.documentElement.style.setProperty("--mq-scale", scale);
        });
      }

      if (delaySlider) {
        autoAdvanceDelayMs = (parseInt(delaySlider.value, 10) || 5) * 1000;
        delaySlider.addEventListener("input", function (e) {
          var secs = parseInt(e.target.value, 10) || 5;
          autoAdvanceDelayMs = secs * 1000;
        });
      }

      if (sfxButton) {
        sfxButton.classList.add("mq-sfx-on");
        sfxButton.addEventListener("click", function () {
          sfxOn = !sfxOn;
          sfxButton.textContent = sfxOn ? "SFX: ON" : "SFX: OFF";
          if (sfxOn) {
            sfxButton.classList.add("mq-sfx-on");
          } else {
            sfxButton.classList.remove("mq-sfx-on");
          }
        });
      }

      if (nextButton) {
        nextButton.addEventListener("click", function () {
          if (nextTimer) {
            clearTimeout(nextTimer);
            nextTimer = null;
          }
          var next = getNextItem();
          renderItem(next);
        });
      }

      var playerSelect = $("mq-player");
      var playerAddBtn = $("mq-player-add");
      var playerDeleteBtn = $("mq-player-delete");

      if (playerSelect) {
        playerSelect.addEventListener("change", function (e) {
          var newId = e.target.value;
          if (!players[newId]) return;
          savePlayers();
          activePlayerId = newId;
          var active = players[activePlayerId];
          state = Object.assign(makeEmptyState(), active.state || {});
          if (!state.errorWeakness) state.errorWeakness = {};
          syncSelectorsFromState();
          updateStats();
          updateBadges();
          var next = getNextItem();
          renderItem(next);
        });
      }

      if (playerAddBtn) {
        playerAddBtn.addEventListener("click", function () {
          var name = prompt(
            "New player name:",
            "Player " + (Object.keys(players).length + 1)
          );
          if (!name) return;

          var base = name;
          var counter = 2;
          var existingNames = Object.keys(players).map(function (id) {
            return players[id].name;
          });
          while (existingNames.indexOf(name) !== -1) {
            name = base + " (" + counter + ")";
            counter++;
          }

          var newId = "p" + Date.now();
          players[newId] = {
            name: name,
            state: makeEmptyState()
          };
          activePlayerId = newId;
          state = makeEmptyState();
          syncSelectorsFromState();
          refreshPlayerSelect();
          updateStats();
          updateBadges();
          var next = getNextItem();
          renderItem(next);
        });
      }

      if (playerDeleteBtn) {
        playerDeleteBtn.addEventListener("click", function () {
          if (!activePlayerId || !players[activePlayerId]) return;
          if (Object.keys(players).length === 1) {
            alert("You need at least one player profile.");
            return;
          }
          if (
            !confirm(
              "Delete player '" +
                players[activePlayerId].name +
                "' and their progress?"
            )
          ) {
            return;
          }
          delete players[activePlayerId];
          var remainingIds = Object.keys(players);
          activePlayerId = remainingIds[0];
          var active = players[activePlayerId];
          state = Object.assign(makeEmptyState(), active.state || {});
          if (!state.errorWeakness) state.errorWeakness = {};
          refreshPlayerSelect();
          syncSelectorsFromState();
          updateStats();
          updateBadges();
          var next = getNextItem();
          renderItem(next);
        });
      }

      // Initial render
      loadPlayers();
      refreshPlayerSelect();
      syncSelectorsFromState();
      applyVisualToggles();
      updateStats();
      updateBadges();
      updateScoreboard();
      var first = getNextItem();
      renderItem(first);
    });
  </script>
</body>
</html>
